<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kid Sequencer - Login</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700;800;900&display=swap");

    :root{
      --ink:#1d1d1d;
      --bg:#f6fbff;
      --card:#ffffff;
      --shadow:rgba(0,0,0,0.10);
      --muted:rgba(31,42,68,0.75);
      --brand:#18b118;
      --danger:#7a1b1b;
      --dangerBg:#fff4f4;
      --tabBg:#eaf2ff;
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:var(--bg);
      font-family:"Trebuchet MS", Arial, sans-serif;
      color:#1f2a44;
    }

    .shell{
      width:min(980px,96vw);
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:18px;
      align-items:stretch;
    }

    .panel{
      border:4px solid var(--ink);
      border-radius:22px;
      background:var(--card);
      box-shadow:0 16px 0 var(--shadow);
      overflow:hidden;
    }

    .brand{
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:16px;
      min-height:520px;
    }

    .badge{
      width:170px;height:170px;
      border-radius:50%;
      border:4px solid var(--ink);
      background:#fff;
      box-shadow:0 10px 0 rgba(0,0,0,0.07);
      display:flex;align-items:center;justify-content:center;
      font-family:"Fredoka", Arial, sans-serif;
      font-weight:900;
      font-size:22px;
      letter-spacing:0.5px;
      user-select:none;
    }

    .appTitle{
      font-family:"Fredoka","Trebuchet MS", Arial, sans-serif;
      font-weight:900;
      font-size:34px;
      line-height:1.05;
      margin:0;
    }
    .tagline{
      margin:0;
      font-weight:900;
      color:var(--muted);
      font-size:14px;
    }

    .bullets{display:grid;gap:10px;margin-top:18px;}
    .bullet{display:flex;gap:10px;align-items:flex-start;font-weight:900;color:#1f2a44;font-size:14px;}
    .dot{width:12px;height:12px;border-radius:6px;border:3px solid var(--ink);background:#fff;margin-top:2px;flex:0 0 auto;}

    .auth{
      padding:22px;
      display:flex;
      flex-direction:column;
      gap:14px;
      min-height:520px;
    }

    .tabs{
      display:flex;
      gap:8px;
      justify-content:center;
      margin-top:2px;
    }
    .tab{
      border:4px solid var(--ink);
      background:#fff;
      border-radius:16px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      box-shadow:0 8px 0 rgba(0,0,0,0.07);
      transition:transform 120ms ease;
      min-width:140px;
    }
    .tab:hover{transform:translateY(-1px);}
    .tab.active{background:var(--tabBg);}

    .divider{
      display:flex;align-items:center;gap:10px;
      opacity:0.7;
      margin:6px 0;
      font-weight:900;
      font-size:12px;
    }
    .divider:before,.divider:after{
      content:"";
      height:2px;
      background:rgba(0,0,0,0.12);
      flex:1;
    }

    form{display:grid;gap:10px;}
    label{text-align:left;font-weight:900;font-size:13px;}
    input{
      height:46px;
      border-radius:14px;
      border:4px solid var(--ink);
      padding:0 12px;
      font-weight:900;
      font-size:14px;
      outline:none;
      background:#fff;
    }

    .primary{
      height:56px;
      border-radius:16px;
      border:4px solid var(--ink);
      background:#fff;
      box-shadow:0 10px 0 rgba(0,0,0,0.07);
      font-weight:900;
      font-size:18px;
      cursor:pointer;
      transition:transform 120ms ease;
      color:var(--brand);
    }
    .primary:hover{transform:translateY(-1px);}

    .secondary{
      height:48px;
      border-radius:16px;
      border:4px solid var(--ink);
      background:#fff;
      box-shadow:0 8px 0 rgba(0,0,0,0.07);
      font-weight:900;
      font-size:14px;
      cursor:pointer;
      transition:transform 120ms ease;
      color:#1f2a44;
    }
    .secondary:hover{transform:translateY(-1px);}

    .hint{
      margin:0;
      font-weight:900;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
      text-align:center;
    }

    .err{
      display:none;
      border:4px solid var(--ink);
      border-radius:16px;
      background:var(--dangerBg);
      padding:10px 12px;
      font-weight:900;
      color:var(--danger);
      box-shadow:0 8px 0 rgba(0,0,0,0.07);
      font-size:13px;
    }

    .foot{
      margin-top:auto;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .tiny{
      font-size:11px;
      opacity:0.8;
      text-align:center;
      margin:0;
      font-weight:900;
    }

    @media (max-width: 860px){
      .shell{grid-template-columns:1fr;}
      .brand,.auth{min-height:auto;}
      .badge{width:140px;height:140px;}
    }
  </style>
</head>

<body>
  <div class="shell">

    <div class="panel brand">
      <div class="badge">KID<br/>SEQ</div>

      <div>
        <h1 class="appTitle">Kid Sequencer</h1>
        <p class="tagline">Sign in to unlock the greyed-out tools. Free account, no emails sent.</p>

        <div class="bullets">
          <div class="bullet"><span class="dot"></span><span>Unlock extra note lengths + instruments</span></div>
          <div class="bullet"><span class="dot"></span><span>Log in on any device</span></div>
          <div class="bullet"><span class="dot"></span><span>Or… just continue as Guest</span></div>
        </div>
      </div>

      <p class="tiny">Tip: You can always switch back to Guest later.</p>
    </div>

    <div class="panel auth">
      <div class="tabs" role="tablist" aria-label="Login tabs">
        <button class="tab active" id="tabSignIn" type="button">Sign in</button>
        <button class="tab" id="tabRegister" type="button">Create account</button>
      </div>

      <div class="divider">Use email</div>

      <div class="err" id="errBox"></div>

      <form id="signInForm" autocomplete="on">
        <div>
          <label for="siEmail">Email</label>
          <input id="siEmail" name="email" type="email" placeholder="name@example.com" required />
        </div>
        <div>
          <label for="siPass">Password</label>
          <input id="siPass" name="password" type="password" placeholder="••••••••" required />
        </div>
        <button class="primary" type="submit" id="signInBtn">Sign in</button>
        <p class="hint">Forgotten password? (We can add reset next.)</p>
      </form>

      <form id="registerForm" autocomplete="on" style="display:none;">
        <div>
          <label for="reEmail">Email</label>
          <input id="reEmail" name="email" type="email" placeholder="name@example.com" required />
        </div>
        <div>
          <label for="rePass">Password</label>
          <input id="rePass" name="password" type="password" placeholder="Create a password" required minlength="6" />
        </div>
        <div>
          <label for="rePass2">Confirm password</label>
          <input id="rePass2" name="password2" type="password" placeholder="Repeat password" required minlength="6" />
        </div>
        <button class="primary" type="submit" id="registerBtn">Create free account</button>
        <p class="hint">Minimum 6 characters.</p>
      </form>

      <div class="foot">
        <button class="secondary" id="guestBtn" type="button">Continue as Guest</button>
        <p class="tiny">Accounts are handled by Firebase Authentication.<br/>Extra user data is stored in Firestore.</p>
      </div>
    </div>

  </div>

  <script type="module">
    // -----------------------------------------
    // Firebase configuration (YOUR VALUES ADDED)
    // -----------------------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyBokU1u4hJIxZ0Y4U9BxQreI3hnxEJzuwc",
      authDomain: "kid-sequencer.firebaseapp.com",
      projectId: "kid-sequencer",
      storageBucket: "kid-sequencer.firebasestorage.app",
      messagingSenderId: "715996068165",
      appId: "1:715996068165:web:84e127454cb9bb0c35a62c",
      measurementId: "G-3JRQKLK31R"
    };

    // -----------------------------
    // Firebase SDK (module CDN)
    // -----------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // -----------------------------
    // UI wiring
    // -----------------------------
    const params = new URLSearchParams(location.search);
    const returnTo = params.get("return") || "index.html";

    const tabSignIn = document.getElementById("tabSignIn");
    const tabRegister = document.getElementById("tabRegister");
    const signInForm = document.getElementById("signInForm");
    const registerForm = document.getElementById("registerForm");
    const guestBtn = document.getElementById("guestBtn");
    const errBox = document.getElementById("errBox");
    const signInBtn = document.getElementById("signInBtn");
    const registerBtn = document.getElementById("registerBtn");

    function showError(msg){
      errBox.textContent = msg;
      errBox.style.display = "block";
    }
    function clearError(){
      errBox.textContent = "";
      errBox.style.display = "none";
    }
    function setBusy(isBusy){
      [signInBtn, registerBtn, guestBtn, tabSignIn, tabRegister].forEach(el=>{
        if (!el) return;
        el.disabled = isBusy;
        el.style.opacity = isBusy ? "0.7" : "1";
        el.style.cursor = isBusy ? "not-allowed" : "pointer";
      });
    }
    function navTo(url){
      const sep = url.includes("?") ? "&" : "?";
      location.href = url + sep + "ts=" + Date.now();
    }
    function setTab(which){
      clearError();
      const signIn = which === "signin";
      tabSignIn.classList.toggle("active", signIn);
      tabRegister.classList.toggle("active", !signIn);
      signInForm.style.display = signIn ? "grid" : "none";
      registerForm.style.display = signIn ? "none" : "grid";
    }

    tabSignIn.addEventListener("click", ()=> setTab("signin"));
    tabRegister.addEventListener("click", ()=> setTab("register"));

    if ((params.get("mode") || "").toLowerCase() === "register") setTab("register");

    guestBtn.addEventListener("click", ()=>{
      localStorage.setItem("ks_auth", "guest");
      // Keep index.html lock-state keys in sync
      localStorage.removeItem("kidseq_logged_in");
      localStorage.removeItem("ks_uid");
      localStorage.removeItem("kidseq_user_uid");
      localStorage.removeItem("ks_email");
      localStorage.removeItem("kidseq_user_email");
      navTo(returnTo);
    });

    // -----------------------------
    // Init Firebase
    // -----------------------------
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // If already logged in, skip login page
    onAuthStateChanged(auth, (user)=>{
      if (!user) return;
      localStorage.setItem("ks_auth", "user");
        // Keep index.html lock-state keys in sync
        localStorage.setItem("kidseq_logged_in","1");
      localStorage.setItem("ks_uid", user.uid);
        localStorage.setItem("kidseq_user_uid", user.uid);
      localStorage.setItem("ks_email", user.email || "");
        localStorage.setItem("kidseq_user_email", user.email || "");
      navTo(returnTo);
    });

    // -----------------------------
    // Firestore user doc helper
    // -----------------------------
    async function upsertUserDoc(user, extra = {}){
      const ref = doc(db, "users", user.uid);
      await setDoc(ref, {
        uid: user.uid,
        email: user.email || null,
        lastLoginAt: serverTimestamp(),
        ...extra
      }, { merge: true });
    }

    // -----------------------------
    // Sign in
    // -----------------------------
    signInForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearError();

      const email = document.getElementById("siEmail").value.trim();
      const pass  = document.getElementById("siPass").value;

      try{
        setBusy(true);
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        await upsertUserDoc(cred.user); // merge keeps existing
        localStorage.setItem("ks_auth", "user");
        // Keep index.html lock-state keys in sync
        localStorage.setItem("kidseq_logged_in","1");
        localStorage.setItem("ks_uid", cred.user.uid);
        localStorage.setItem("kidseq_user_uid", cred.user.uid);
        localStorage.setItem("ks_email", cred.user.email || "");
        localStorage.setItem("kidseq_user_email", cred.user.email || "");
        navTo(returnTo);
      }catch(err){
        console.error(err);
        showError(humanAuthError(err));
      }finally{
        setBusy(false);
      }
    });

    // -----------------------------
    // Register
    // -----------------------------
    registerForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearError();

      const email = document.getElementById("reEmail").value.trim();
      const pass  = document.getElementById("rePass").value;
      const pass2 = document.getElementById("rePass2").value;

      if (pass !== pass2){
        showError("Passwords do not match.");
        return;
      }
      if ((pass || "").length < 6){
        showError("Password must be at least 6 characters.");
        return;
      }

      try{
        setBusy(true);
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await upsertUserDoc(cred.user, { createdAt: serverTimestamp() });
        localStorage.setItem("ks_auth", "user");
        // Keep index.html lock-state keys in sync
        localStorage.setItem("kidseq_logged_in","1");
        localStorage.setItem("ks_uid", cred.user.uid);
        localStorage.setItem("kidseq_user_uid", cred.user.uid);
        localStorage.setItem("ks_email", cred.user.email || "");
        localStorage.setItem("kidseq_user_email", cred.user.email || "");
        navTo(returnTo);
      }catch(err){
        console.error(err);
        showError(humanAuthError(err));
      }finally{
        setBusy(false);
      }
    });

    function humanAuthError(err){
      const code = (err && err.code) ? String(err.code) : "";
      switch(code){
        case "auth/invalid-email": return "That email address doesn’t look right.";
        case "auth/user-not-found": return "No account found with that email.";
        case "auth/wrong-password": return "Incorrect password.";
        case "auth/invalid-credential": return "Email or password is incorrect.";
        case "auth/email-already-in-use": return "That email already has an account. Try Sign in.";
        case "auth/weak-password": return "Password is too weak. Use at least 6 characters.";
        case "auth/network-request-failed": return "Network error. Check your connection and try again.";
        default: return "Login failed. Check Console for details.";
      }
    }
  </script>
</body>
</html>
