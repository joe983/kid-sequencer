<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Kid Sequencer</title>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700;800;900&display=swap");
    :root{
      --cell: 46px;
      --gap: 4px;
      --toolW: 210px;
      --rightW: 110px;
      --rightLift: 0px;
      --titleInset: 0px;
      --contentLift: 0px;

      --wiggleDeg: 1.2deg;
      --wiggleScale: 0.01;

      /* Robot badge size */
      --robotSizeLanding: 220px;
      --robotSize: var(--robotSizeLanding);
    }

    /* Logged-in: robot is 50% bigger than the landing page */
    body.loggedIn{
      --robotSize: calc(var(--robotSizeLanding) * 1.5);
    }

    body.loggedIn #robotLogo{
      opacity: 1;
      filter: none;
    }

    body{
      font-family: "Trebuchet MS", Arial, sans-serif;
      background: #f6fbff;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    /* Prevent caret/focus blinking artifacts */
    *{ caret-color: transparent; }
    :focus{ outline: none; }
    #page{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      padding-top: 10px;
      padding-bottom: env(safe-area-inset-bottom);
      user-select:none;
      position: relative;
      z-index: 2;
    }

    #topBar{
      pointer-events:none;
      height: 92px;
      padding: 8px 14px 0;
      box-sizing:border-box;
      position: relative;
      z-index: 3;
    }

    #titleBox{
      width: var(--toolW);
      height: 58px;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.06);
      box-sizing:border-box;

      display:flex;
      align-items:center;
      justify-content:center;

      position:absolute;
      left: calc(14px + var(--titleInset));
      top: 8px;
      overflow:hidden;
      line-height: 1;
    }

    #titleBox .titleText{
      font-family: "Fredoka", "Comic Sans MS","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 28px;
      letter-spacing: 0.6px;
      color:#1f2a44;
      white-space:nowrap;
      line-height: 1;
      padding: 0; margin: 0;
      transform: translateY(-0.5px);
      text-shadow:
        0 2px 0 rgba(255,255,255,0.9),
        0 5px 0 rgba(0,0,0,0.08);
    }

    #robotLogo{
      /* Must behave like the rest of the layout (scrolls with the page) */
      position: absolute;
      left: 0;
      top: 0;
      width: var(--robotSize);
      height: var(--robotSize);
      padding: 8px;
      box-sizing: border-box;
      border-radius: 50%;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 9px 0 rgba(0,0,0,0.07);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      z-index: 4;
      opacity: 1;
      overflow: hidden; /* clip any square SVG viewport corners */
    }
    #robotLogo .robotClip{
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #robotLogo svg,
    #robotLogo img{
      width:100%;
      height:100%;
      display:block;
      object-fit: contain;
    }


    /* Everything except the title gets lifted together */
    #contentWrap{
      transform: translateY(calc(-1 * var(--contentLift)));
      will-change: transform;
      position: relative;
      z-index: 2;
    }

    #controls{
      display:flex;
      justify-content:center;
      align-items:center;
      gap: 10px;
      margin: 6px 0 8px;
      flex-wrap: nowrap;
    }
    #controls .bigBtn{ margin: 0; }
    .bigBtn{
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
      font-size:18px;
      padding: 10px 16px;
      margin: 5px;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      cursor:pointer;
      font-weight: 900;
      box-shadow: 0 9px 0 rgba(0,0,0,0.07);
      transition: transform 120ms ease;
      touch-action: manipulation;
      min-width: 88px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
    }
    .bigBtn.iconBtn{
      padding: 0;
      width: 76px;
      height: 58px;
    }

    .bigBtn .icon{
      line-height: 1;
      display:flex;
      align-items:center;
      justify-content:center;
      width: 100%;
      height: 100%;
      transform: none;
    }
    .bigBtn .icon svg{
  display:block;
  width: 38px;
  height: 38px;
}
.bigBtn .playIcon{ color: #18b118; }
.bigBtn .stopIcon{ color: #e02b2b; }
.bigBtn .undoIcon{ color: #111111; }
.bigBtn .clearIcon{ color: #111111; }
.bigBtn .cameraIcon{ color: #111111; }

.bigBtn .clearIcon svg{ width: 28px; height: 28px; }
.bigBtn .undoIcon svg{ width: 30px; height: 30px; transform: translateX(-1px); }
.bigBtn .cameraIcon svg{ width: 34px; height: 34px; }
.bigBtn:hover{ transform: translateY(-1px); }

    #mainLayout{
      flex: 1;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap: 14px;
      padding: 0 14px 12px;
      box-sizing:border-box;
    }

    #tools{
      width: var(--toolW);
      display:flex;
      flex-direction:column;
      gap: 10px;
      flex: 0 0 auto;
    }

    .tool{
      width: 100%;
      height: 58px;
      border: 4px solid #1d1d1d;
      background: #ffffff;
      cursor:pointer;
      display:flex;
      align-items:center;
      padding: 8px 10px;
      border-radius: 16px;
      box-sizing: border-box;
      box-shadow: 0 8px 0 rgba(0,0,0,0.06);
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      touch-action: manipulation;
    }
    .tool:hover{
      transform: translateY(-1px);
      box-shadow: 0 9px 0 rgba(0,0,0,0.07);
      background:#fbfdff;
    }
    .tool.selected{
      background:#eaf2ff;
      box-shadow: 0 9px 0 rgba(0,0,0,0.10);
    }

    .toolSymbol{
      width: 48px;
      height: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      margin-right: 8px;
      color:#1d1d1d;
      text-shadow: 0 1px 0 rgba(255,255,255,0.8);
      font-size: 32px;
      line-height: 1;
    }
    .toolSymbol.big{ font-size: 40px; }
    .toolSymbol.normal{ font-size: 34px; }
    .toolSymbol.sixteenth{ font-size: 38px; }
    .toolSymbol.eighth{ font-size: 32px; }

    .toolBarWrap{
      flex: 1;
      height: 32px;
      display:flex;
      align-items:center;
      gap: 6px;
    }

    .toolBar{
      position: relative;
      flex: 1;
      height: 24px;
      border: 4px solid #1d1d1d;
      background: #fff;
      border-radius: 10px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .toolBarFill{
      position:absolute;
      left:0; top:0; bottom:0;
      width: calc(var(--fill) * 100%);
      background:#1d1d1d;
      border-top-right-radius: 7px;
      border-bottom-right-radius: 7px;
    }

    .toolBarDivs{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: 0.24;
      background-image: repeating-linear-gradient(
        to right,
        rgba(0,0,0,0) 0,
        rgba(0,0,0,0) calc((100% / var(--divs)) - 2px),
        rgba(0,0,0,0.95) calc((100% / var(--divs)) - 2px),
        rgba(0,0,0,0.95) calc(100% / var(--divs))
      );
    }

    .toolLabel{
      width: 58px;
      font-size: 14px;
      font-weight: 900;
      text-align:right;
      color:#1f2a44;
    }
    .toolLabel.comicWhole{
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
    }

    #sequencerShell{
      border: 4px solid #1d1d1d;
      border-radius: 18px;
      background: #ffffff;
      padding: 12px;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      flex: 0 0 auto;
    }

    #sequencerWrapper{
      position: relative;
      border-radius: 14px;
      overflow: hidden;
    }

    /* -------------------- DRUMS PANEL -------------------- */
    #drumPanel{
      margin-top: 10px;
      width: calc(var(--cell) * 16 + var(--gap) * 15);
      border: 4px solid #1d1d1d;
      border-radius: 16px;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.06);
      padding: 8px 10px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content: flex-start;
      gap: 10px;
      user-select:none;
    }

    #drumLeft{
      display:flex;
      flex-direction:column;
      gap: 2px;
      min-width: 86px;
    }

    .drumTitle{
      font-family: "Fredoka", "Comic Sans MS","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 18px;
      color:#1f2a44;
      line-height: 1;
    }

    .drumStatus{
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 12px;
      opacity: 0.78;
      color:#1f2a44;
      line-height: 1;
    }

    #drumControls{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content: flex-start;
      gap: 10px;
      flex-wrap: wrap;
    }

    .drumMiniBtn{
      width: 56px;
      height: 56px;
      border-radius: 14px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      cursor:pointer;
      font-size: 24px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      transition: transform 120ms ease, background 120ms ease, opacity 120ms ease, filter 120ms ease;
      touch-action: manipulation;
      padding: 0;
    }
    .drumMiniBtn:hover{ transform: translateY(-1px); }
    .drumMiniBtn:active{ transform: translateY(0); }
    .drumMiniBtn.muted{ opacity: 0.72; }

    .drumStyleGroup{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-start; }

    .drumStyleBtn{
      width: 56px;
      height: 56px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 0;
      border: 3px solid #1d1d1d;
      border-radius: 14px;
      background:#ffffff;
      cursor:pointer;
      box-shadow: 0 6px 0 rgba(0,0,0,0.08);
      transition: transform 90ms ease;
    }
.drumStyleBtn:hover{ transform: translateY(-1px); }
    .drumStyleBtn:active{ transform: translateY(0); }
    .drumStyleBtn.selected{ background:#eaf2ff; }

    .drumIcon{
      width: 82%;
      height: 82%;
      display:block;
      object-fit: contain;
      pointer-events:none;
    }



    .rowWrap{
      position:relative;
      margin-bottom: var(--gap);
      width: calc(var(--cell) * 16 + var(--gap) * 15);
      height: var(--cell);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(16, var(--cell));
      gap: var(--gap);
    }

    .cell{
      width: var(--cell);
      height: var(--cell);
      background:#ffffff;
      border: 3px solid #1d1d1d;
      box-sizing:border-box;
      cursor:pointer;
      border-radius: 12px;
      transition: transform 90ms ease;
      touch-action: manipulation;
    }
    .cell:hover{ transform: scale(1.02); }

    .noteLayer{
      position:absolute;
      left:0; top:0;
      width:100%; height:100%;
      pointer-events:none;
    }

    .noteBlock{
      position:absolute;
      height: var(--cell);
      border: 4px solid rgba(0,0,0,0.92);
      box-sizing:border-box;
      border-radius: 14px;
      pointer-events:auto;
      cursor:pointer;
      box-shadow: 0 8px 0 rgba(0,0,0,0.08);
      transform-origin:center center;
      touch-action: manipulation;
      overflow:hidden; /* needed for candy-bar overlay */
    }

    /* Candy-bar inner bevel (cartoony) */
    .noteBlock::before{
      content:"";
      position:absolute;
      inset: 3px;
      border-radius: 10px;
      pointer-events:none;
      box-shadow:
        inset 0 3px 0 rgba(255,255,255,0.35),
        inset 0 -3px 0 rgba(0,0,0,0.10);
      opacity: 0.9;
    }

    /* Candy-bar segments overlay (replaces dot pattern) */
    .noteBlock::after{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;

      /* 3 layers:
         1) alternating panel tint per cell
         2) separator lines at boundaries
         3) glossy highlight stripe near the top
      */
      background-image:
        /* 1) alternating panel tint */
        repeating-linear-gradient(
          to right,
          rgba(255,255,255,0.00) 0,
          rgba(255,255,255,0.00) calc(var(--cell)),
          rgba(0,0,0,0.06)        calc(var(--cell)),
          rgba(0,0,0,0.06)        calc(var(--cell) + var(--gap))
        ),

        /* 2) separators at boundaries */
        repeating-linear-gradient(
          to right,
          rgba(0,0,0,0.00) 0,
          rgba(0,0,0,0.00) calc(var(--cell) - 3px),
          rgba(0,0,0,0.24) calc(var(--cell) - 3px),
          rgba(0,0,0,0.24) calc(var(--cell) - 0px),
          rgba(0,0,0,0.00) calc(var(--cell)),
          rgba(0,0,0,0.00) calc(var(--cell) + var(--gap))
        ),

        /* 3) glossy top highlight */
        linear-gradient(
          to bottom,
          rgba(255,255,255,0.42) 0%,
          rgba(255,255,255,0.18) 32%,
          rgba(255,255,255,0.00) 60%
        );

      background-size:
        calc(var(--cell) + var(--gap)) 100%,
        calc(var(--cell) + var(--gap)) 100%,
        100% 100%;

      background-repeat: repeat, repeat, no-repeat;
      opacity: 1;
    }

    @keyframes swell {
      0%   { transform: scale(1,1); }
      40%  { transform: scale(var(--sx,1.03), var(--sy,1.03)); }
      70%  { transform: scale(var(--sx2,1.01), var(--sy2,1.01)); }
      100% { transform: scale(1,1); }
    }
    .noteBlock.playing{ animation: swell 260ms ease-out; }

    #playhead{
      position:absolute;
      top:0; bottom:0;
      width: var(--cell);
      left: 0;
      pointer-events:none;
      border-radius: 12px;
      background: rgba(255,255,255,0.30);
      border: 4px solid rgba(0,0,0,0.22);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.25) inset;
      transition: left 70ms linear;
      transform-origin: 50% 50%;
    }
    #playhead::after{
      content:"";
      position:absolute;
      top:6px; bottom:6px;
      left: 50%;
      width: 0;
      border-left: 3px dashed rgba(0,0,0,0.18);
      transform: translateX(-50%);
    }

    @keyframes wiggle {
      0%   { transform: rotate(calc(-1 * var(--wiggleDeg))) scale(calc(1 + var(--wiggleScale))); }
      50%  { transform: rotate(var(--wiggleDeg))           scale(calc(1 + var(--wiggleScale))); }
      100% { transform: rotate(calc(-1 * var(--wiggleDeg))) scale(calc(1 + var(--wiggleScale))); }
    }
    #playhead.playing{ animation: wiggle 220ms ease-in-out infinite; }

    #rightCol{
      width: var(--rightW);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 12px;
      flex: 0 0 auto;
      transform: translateY(calc(-1 * var(--rightLift)));
      will-change: transform;
    }

    #tempoControls{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
      width: 100%;
    }
    #tempoControls button{
      width:58px;
      height:58px;
      font-size:30px;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      cursor:pointer;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      transition: transform 120ms ease;
      touch-action: manipulation;
    }
    #tempoControls button:hover{ transform: translateY(-1px); }

    #tempoBox{
      width:74px;
      text-align:center;
      font-size:22px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      padding: 12px 0;
      border-radius: 16px;
      font-weight: 900;
      color:#1f2a44;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      user-select:none;
    }

    #instButtons{
      display:flex;
      flex-direction:column;
      gap: 10px;
      width: 58px;
    }

    .instBtn{
      width: 58px;
      height: 58px;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 34px;
      transition: transform 120ms ease, filter 120ms ease, opacity 120ms ease, background 120ms ease;
      touch-action: manipulation;
      box-sizing:border-box;
    }
    .instBtn:hover{ transform: translateY(-1px); }

    .instBtn.selected{ background:#eaf2ff; opacity: 1; filter: none; }
    .instBtn.notSelected{ opacity: 0.42; filter: grayscale(0.95); }

    .waveIcon{ width: 46px; height: 28px; display:block; }

    #rotatePrompt{
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255,255,255,0.95);
      border: 4px solid #1d1d1d;
      border-radius: 18px;
      box-shadow: 0 8px 0 rgba(0,0,0,0.10);
      padding: 10px 14px;
      display:none;
      align-items:center;
      gap: 10px;
      max-width: min(520px, calc(100vw - 24px));
      box-sizing:border-box;
    }
    #rotatePrompt .emoji{ font-size: 26px; }
    #rotatePrompt .text{
      font-weight: 900;
      color:#1f2a44;
      font-size: 14px;
      line-height: 1.2;
    }
    #rotatePrompt .sub{
      display:block;
      font-weight: 800;
      opacity: 0.75;
      margin-top: 2px;
      font-size: 12px;
    }


    /* Camera scan modal */
    #camModal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; z-index: 10000; background: rgba(0,0,0,0.45); padding: 18px; box-sizing: border-box; }
    #camModal.show{ display:flex; }
    .modalCard{ width: min(620px, 96vw); background:#fff; border: 4px solid #1d1d1d; border-radius: 18px; box-shadow: 0 9px 0 rgba(0,0,0,0.12); overflow:hidden; }
    .modalHeader{ display:flex; align-items:center; justify-content:space-between; padding: 10px 12px; border-bottom: 4px solid #1d1d1d; }
    .modalTitle{ font-weight: 900; color:#1f2a44; font-size: 16px; }
    .modalClose{ width:46px; height:46px; border-radius: 14px; border: 4px solid #1d1d1d; background:#fff; cursor:pointer; font-weight: 900; font-size: 18px; box-shadow: 0 8px 0 rgba(0,0,0,0.07); }
    .camStage{ position: relative; aspect-ratio: 4 / 3; background:#111; }
    #camVideo, #camPreview{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; }
    #camPreview{ display:none; }
    .camOverlay{ position:absolute; inset:10px; border: 4px dashed rgba(255,255,255,0.75); border-radius: 14px; pointer-events:none; }
    .camOverlay::before{ content:""; position:absolute; inset:0; background-image:
      repeating-linear-gradient(to right, rgba(255,255,255,0.22) 0, rgba(255,255,255,0.22) 1px, rgba(255,255,255,0) 1px, rgba(255,255,255,0) calc((100% / 16))),
      repeating-linear-gradient(to bottom, rgba(255,255,255,0.22) 0, rgba(255,255,255,0.22) 1px, rgba(255,255,255,0) 1px, rgba(255,255,255,0) calc((100% / 8)));
      border-radius: 10px;
    }
    .modalBtns{ display:flex; gap: 10px; justify-content:center; padding: 12px; }
    .modalHint{ padding: 0 14px 14px; text-align:center; font-weight: 800; opacity: 0.75; font-size: 12px; }

    /* Locked controls + login hints */
    .tool.locked{
      opacity: 0.35;
      filter: grayscale(1);
      cursor: not-allowed;
    }
    .tool.locked:hover{
      transform: none;
      background:#f3f5f7;
      box-shadow: 0 8px 0 rgba(0,0,0,0.06);
    }

    /* Grey out individual control buttons when locked */
    .bigBtn.locked{ opacity: 0.35; filter: grayscale(1); cursor: not-allowed; }
    .bigBtn.locked:hover{ transform: none; }
    .bigBtn.locked:active{ transform: none; }

    #tempoControls.locked button,
    #tempoControls.locked #tempoBox{
      opacity: 0.35;
      filter: grayscale(1);
      cursor: not-allowed;
    }
    #tempoControls.locked button:hover{ transform: none; }

    #toolsList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      width: 100%;
    }
    #toolsLoginArea{
      width: 100%;
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap: 8px;
    }
    #toolHintSlot{
      height: 36px;
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .loginHint{
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 14px;
      padding: 8px 12px;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      color:#1f2a44;
      text-decoration:none;
      opacity: 0;
      transform: translateY(4px);
      pointer-events: none;
      transition: opacity 140ms ease, transform 140ms ease;
      user-select:none;
      white-space: nowrap;
    }
    .loginHint.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .loginBtn{
      width: 120px;
      height: 54px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius: 16px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      color: #18b118;
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 20px;
      text-decoration:none;
      transition: transform 120ms ease;
      touch-action: manipulation;
    }
    .loginBtn:hover{ transform: translateY(-1px); }

    #tempoControls{ position:relative; }
    #tempoLoginHint{
      position:absolute;
      left: calc(100% + 12px);
      top: 50%;
      transform: translateY(-50%);
    }
body.loggedIn #toolsLoginArea{ display:none; }

#loginCtaWrap{
  position: relative;
  width: 120px;
  height: 54px;
  display: inline-block;
}
#loginCtaWrap .loginBtn{
  position: relative;
  z-index: 2;
}
#loginCtaWrap.pulsing .loginBtn{
  animation: loginSwell 760ms ease-in-out infinite;
}
#loginCtaWrap.pulsing .loginBtn:hover{ transform: none; }
@keyframes loginSwell{
  0%,100%{ transform: translateY(0) scale(1,1); }
  18%{ transform: translateY(-1px) scale(1.08,0.96); }
  50%{ transform: translateY(-2px) scale(0.96,1.12); }
  72%{ transform: translateY(-1px) scale(1.05,0.98); }
  86%{ transform: translateY(-1px) scale(1.02,1.02); }
}



#instButtons.locked .instBtn{
  opacity: 0.35;
  filter: grayscale(1);
  cursor: not-allowed;
}
#instButtons.locked .instBtn:hover{ transform: none; }






    /* Guest mode stamp */
    body.loggedIn /* Logout button */
    #logoutBtn{
      position: fixed;
      left: 14px;
      bottom: calc(12px + env(safe-area-inset-bottom));
      height: 40px;
      padding: 0 12px;
      border-radius: 14px;
      border: 4px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 8px 0 rgba(0,0,0,0.07);
      font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 14px;
      cursor:pointer;
      display:none;
      align-items:center;
      justify-content:center;
      transition: transform 120ms ease;
      z-index: 9999;
    }
    body.loggedIn #logoutBtn{ display:flex; }
    #logoutBtn:hover{ transform: translateY(-1px); }
    #logoutBtn:active{ transform: translateY(0); }


  

    /* -------------------- MASTER VOLUME FADER (UI ONLY) -------------------- */
    :root{ --instBtnSize: 58px; --instGap: 10px; }

    /* Give the right column enough width for fader + VOL box */
    :root{ --rightW: 150px; }

    .seqFaderRow{
      width: 100%;
      position: relative;
      display:flex;
      align-items:flex-end;
      justify-content:center; /* center the fader itself */
      margin-top: 6px;
      padding-bottom: 2px;
    }

    .seqFaderPanel{
      width: var(--instBtnSize);
      border-radius: 18px;
      border: 3px solid #1d1d1d; /* thinner */
      background:#ffffff;
      box-shadow: 0 6px 0 rgba(0,0,0,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 4px;
    }

    .seqTrackArea{
      position: relative;
      /* Much shorter, while still ending at grid bottom */
      height: calc((var(--cell) * 8 + var(--gap) * 7) - (4 * var(--instBtnSize) + 3 * var(--instGap)) - 70px);
      width: var(--instBtnSize);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .seqTrack{
      position: relative;
      width: 3px;      /* just enough to host the line */
      height: 100%;
      border: none;    /* remove surrounding shape */
      background: transparent;
      box-shadow: none;
      overflow: visible;
    }

    
    .seqTrack:before{
      content:"";
      position:absolute;
      left:50%;
      top:0;
      transform: translateX(-50%);
      width: 3px; /* thin central line */
      height: 100%;
      border-radius: 999px;
      background:#0f0f0f;
      opacity: 1;
      pointer-events:none;
    }
.seqIncTicks{
      position:absolute;
      left: 50%;          /* left edge sits on the track center line */
      margin-left: 0;
      top: 10px;          /* inset to match the visible track between caps */
      bottom: 10px;
      height: auto;
      width: 6px;         /* small container */
      display:flex;
      flex-direction: column;
      justify-content: space-between; /* evenly space 8 ticks */
      pointer-events:none;
      opacity: 0.95;
    }
    .seqIncTicks .t{
      width: 4px;   /* one third as long */
      height: 2px;
      background:#0f0f0f;
      border-radius: 2px;
    }
    
    .seqIncTicks .t:first-of-type,
    .seqIncTicks .t:last-of-type{ visibility:hidden; }

    .seqCaps{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      height: 100%;
      width: 9px;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center; /* ensure caps are centered on the track line */
      pointer-events:none;
    }
    .seqCap{
      display:block;
      width: 9px;
      height: 9px;
      border-radius: 999px;
      border: 2px solid #1d1d1d;
      background:#fff;
      box-shadow: 0 2px 0 rgba(0,0,0,0.05);
    }

    .seqKnob{
      position:absolute;
      left: 50%;
      transform: translate(-50%, -50%);
      width: calc(var(--instBtnSize) - 10px); /* slightly narrower than sound buttons */
      height: 16px;              /* thinner */
      border-radius: 11px;
      border: 3px solid #1d1d1d; /* thin outline */
      background:#ffffff;
      box-shadow:
        0 5px 0 rgba(0,0,0,0.05),
        inset 0 2px 0 rgba(255,255,255,0.85);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }

    .seqKnobStripe{
      width: 70%;
      height: 7px;
      border-radius: 999px;
      border: 3px solid rgba(29,29,29,0.70);
      background: rgba(216,240,255,0.75);
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.55);
    }

    .seqReadout{
      position:absolute;
      left: 50%;
      transform: translateX(calc(var(--instBtnSize) / 2 + 10px)); /* sits to the right without shifting fader */
      bottom: 2px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 3px solid #1d1d1d;
      background:#ffffff;
      box-shadow: 0 6px 0 rgba(0,0,0,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction: column;
      gap: 2px;
      padding: 4px;
      flex: 0 0 auto;
    }
    .seqReadout .small{
      font-family: "Fredoka","Trebuchet MS", Arial, sans-serif;
      font-weight: 800;
      font-size: 9px;
      color: rgba(31,42,68,0.70);
      letter-spacing: 0.4px;
      line-height: 1;
    }
    .seqReadout .num{
      font-family: "Fredoka","Trebuchet MS", Arial, sans-serif;
      font-weight: 900;
      font-size: 16px;
      color:#1f2a44;
      line-height: 1;
      text-shadow:
        0 2px 0 rgba(255,255,255,0.9),
        0 4px 0 rgba(0,0,0,0.08);
    }
    /* ---------------------------------------------------------------------- */

  
    /* --- Master volume fader interaction --- */
    .seqTrackArea{ position: relative; }
    .seqVolRange{
      position:absolute;
      left: 50%;
      top: 0;
      transform: translateX(-50%) rotate(-90deg);
      transform-origin: center;
      width: calc(100% - 6px); /* matches track height after rotation */
      height: 28px;
      opacity: 0; /* invisible but interactive */
      cursor: pointer;
      z-index: 20;
    }
    /* prevent default focus ring from shifting layout */
    .seqVolRange:focus{ outline: none; }


    
    /* Member/Guest pill (right of header) */
    #memberPill{
      position:absolute;
      left: calc(14px + var(--titleInset) + var(--toolW) + 12px); /* gap to the right of title box */
      top: 18px;
      height: 34px;
      padding: 0 14px;
      border-radius: 999px;
      background: #dff1ff;
      border: 3px solid #1d1d1d;
      box-shadow: 0 6px 0 rgba(0,0,0,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family: "Trebuchet MS", Arial, sans-serif;
      font-weight: 800;
      font-size: 13px;
      color: #1f2a44;
      letter-spacing: 0.3px;
      user-select:none;
      z-index: 50;
    }

    /* -------------------- Mobile portrait tabs (Grid / Tools / Sounds) -------------------- */
    #mobileTabs{ display:none; }
    @media (max-width: 820px) and (orientation: portrait){
      /* Portrait mobile uses tabs, so don't nag users to rotate */
      #rotatePrompt{ display:none !important; }

      /* Keep the robot badge sensible on phones */
      :root{ --robotSizeLanding: clamp(96px, 28vw, 150px); }
      body.loggedIn{ --robotSize: calc(var(--robotSizeLanding) * 1.2); }

      #page{
        padding-bottom: calc(env(safe-area-inset-bottom) + 72px);
      }

      #mainLayout{
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
        padding: 0 12px 12px;
      }

      /* Tabs: fixed bottom bar */
      #mobileTabs{
        display:flex;
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: calc(env(safe-area-inset-bottom) + 8px);
        height: 56px;
        background:#ffffff;
        border: 4px solid #1d1d1d;
        border-radius: 18px;
        box-shadow: 0 8px 0 rgba(0,0,0,0.06);
        box-sizing: border-box;
        z-index: 120;
        padding: 4px;
        gap: 4px;
      }
      #mobileTabs .tabBtn{
        flex:1;
        border: none;
        background: transparent;
        border-radius: 14px;
        font-family: "Fredoka","Trebuchet MS",Arial,sans-serif;
        font-weight: 900;
        font-size: 16px;
        color:#1f2a44;
        cursor: pointer;
      }
      #mobileTabs .tabBtn.active{
        background:#eaf2ff;
        box-shadow: inset 0 0 0 3px #1d1d1d;
      }

      /* Full-width panels on mobile */
      #tools, #rightCol{ width: 100%; }
      #sequencerShell{ width: 100%; display:flex; justify-content:center; }

      /* Make tool buttons fit comfortably */
      #toolsList{ display:flex; flex-wrap:wrap; gap: 10px; justify-content:center; }
      #toolsList .tool{ width: calc(50% - 6px); max-width: 320px; }

      /* Tab panel visibility */
      body[data-mobile-tab="grid"]  #tools,
      body[data-mobile-tab="grid"]  #rightCol{ display:none; }

      body[data-mobile-tab="tools"] #sequencerShell,
      body[data-mobile-tab="tools"] #rightCol{ display:none; }

      body[data-mobile-tab="sounds"] #sequencerShell,
      body[data-mobile-tab="sounds"] #tools{ display:none; }
    }

/* ================= MOBILE PHONE (LANDSCAPE) OVERRIDES ONLY =================
   NOTE: These rules only apply on touch phones in landscape (coarse pointer),
   so desktop/tablet layouts remain unchanged.
*/
@media (hover: none) and (pointer: coarse) and (orientation: landscape) and (max-width: 980px) and (max-height: 520px){
  /* Hide the left tools column on mobile-landscape (moved into left drawer) */
  #tools{ display:none !important; }

  /* Hide tempo + master volume where they normally live (moved into right drawer) */
  #rightCol #tempoControls,
  #rightCol #masterVolUI{ display:none !important; }

  /* Hide the tools login CTA area on mobile-landscape (login lives in top controls beside camera) */
  #toolsLoginArea{ display:none !important; }

  /* Don't show the fixed logout button on mobile-landscape (logout lives beside camera) */
  #logoutBtn{ display:none !important; }

  /* The pill is moved next to the camera button in mobile-landscape */
  #topBar #memberPill{ display:none !important; }

  /* Drawer overlay */
  #drawerOverlay{
    display:none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.25);
    z-index: 9996;
  }
  #drawerOverlay.open{ display:block; }

  /* Drawer handles (edge tabs) */
  .drawerHandle{
    display:flex;
    align-items:center;
    justify-content:center;
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 38px;
    height: 52px;
    border-radius: 0 16px 16px 0;
    border: 4px solid #1d1d1d;
    background:#ffffff;
    box-shadow: 0 8px 0 rgba(0,0,0,0.07);
    font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
    font-weight: 900;
    cursor:pointer;
    z-index: 9997;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .drawerHandle.right{
    right: 0;
    left: auto;
    border-radius: 16px 0 0 16px;
  }
  .drawerHandle.left{
    left: 0;
    right: auto;
  }

  /* Drawers */
  .drawer{
    position: fixed;
    top: 0;
    bottom: 0;
    width: min(78vw, 340px);
    background:#f6fbff;
    border: 4px solid #1d1d1d;
    box-shadow: 0 12px 0 rgba(0,0,0,0.10);
    z-index: 9998;
    display:flex;
    flex-direction:column;
    padding: 10px;
    box-sizing:border-box;
    transform: translateX(-110%);
    transition: transform 180ms ease;
  }
  .drawer.right{
    right: 0;
    left: auto;
    transform: translateX(110%);
  }
  .drawer.open.left{ transform: translateX(0); }
  .drawer.open.right{ transform: translateX(0); }

  .drawerTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    padding: 4px 2px 10px;
  }
  .drawerTitle{
    font-family: "Fredoka", "Comic Sans MS","Trebuchet MS", Arial, sans-serif;
    font-weight: 900;
    font-size: 18px;
    color:#1f2a44;
    white-space:nowrap;
  }
  .drawerClose{
    width: 44px;
    height: 44px;
    border-radius: 14px;
    border: 4px solid #1d1d1d;
    background:#ffffff;
    box-shadow: 0 8px 0 rgba(0,0,0,0.07);
    font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
    font-weight: 900;
    font-size: 22px;
    cursor:pointer;
    line-height: 1;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .drawerContent{
    flex: 1;
    overflow:auto;
    padding-right: 6px;
    -webkit-overflow-scrolling: touch;
  }

  /* Mobile auth group (pill + login/logout) */
  #mobileAuthGroup{
    position: absolute; /* positioned by JS relative to #contentWrap */
    display:none;
    align-items:center;
    gap: 8px;
    z-index: 9995;
    pointer-events:auto;
  }
  #mobileAuthGroup .topAuthBtn{
    height: 40px;
    padding: 0 12px;
    border-radius: 14px;
    border: 4px solid #1d1d1d;
    background:#ffffff;
    box-shadow: 0 8px 0 rgba(0,0,0,0.07);
    font-family: "Comic Sans MS","Comic Sans","Trebuchet MS", Arial, sans-serif;
    font-weight: 900;
    font-size: 14px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    white-space:nowrap;
  }
  /* Ensure the member pill looks good inline */
  #mobileAuthGroup #memberPill{
    position: static !important;
    top:auto !important;
    left:auto !important;
    height: 40px;
    border-width: 4px;
    box-shadow: 0 8px 0 rgba(0,0,0,0.06);
    pointer-events:auto;
  }

  /* --- Requested mobile-landscape layout tweaks (Jan 2026) --- */
  :root{ --topH: 29px; }

  /* Lift drawer tabs upward (~25% above center) */
  .drawerHandle{ top: 30%; }

  /* Title box sizing (position/width is set by mobile JS so it lines up with the grid) */
  #titleBox{
    height: var(--topH) !important;
    border-radius: 12px !important;
    top: 8px !important;
  }
  .titleText{
    font-size: 14px !important;
    letter-spacing: 0.2px !important;
    transform: none !important;
  }

  /* Make transport/camera buttons square and same height as the header box */
  .bigBtn.iconBtn{
    width: var(--topH) !important;
    height: var(--topH) !important;
    border-radius: 10px !important;
    box-shadow: 0 5px 0 rgba(0,0,0,0.07) !important;
  }
  .icon svg{
    width: calc(var(--topH) * 0.70) !important;
    height: calc(var(--topH) * 0.70) !important;
  }

  /* Mobile auth group sizing: login aligns with button centers; pill slightly smaller */
  #mobileAuthGroup{ gap: 0 !important; }
  #mobileAuthGroup .topAuthBtn{
    height: var(--topH) !important;
    padding: 0 10px !important;
    border-radius: 12px !important;
    font-size: 13px !important;
    box-shadow: 0 5px 0 rgba(0,0,0,0.07) !important;
  }
  #mobileAuthGroup #memberPill{
    height: calc(var(--topH) - 6px) !important;
    padding: 0 8px !important;
    font-size: 12px !important;
    border-radius: 999px !important;
    margin-right: 10px !important;
  }


  /* Main page: remove left column space, push right column to screen edge, let grid use remaining width */
  #mainLayout{
    justify-content: space-between !important;
    width: 100% !important;
    padding: 0 10px 10px !important;
    gap: 10px !important;
  }
  #rightCol{
    display:flex !important;
    flex-direction: column !important;
    align-items: flex-end !important;
    justify-content: flex-start !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }

  /* Transport/camera icons: force-fit inside square buttons */
  .bigBtn.iconBtn .icon svg{
    width: calc(var(--topH) * 0.66) !important;
    height: calc(var(--topH) * 0.66) !important;
  }
  .bigBtn .clearIcon svg,
  .bigBtn .undoIcon svg,
  .bigBtn .cameraIcon svg{
    width: calc(var(--topH) * 0.66) !important;
    height: calc(var(--topH) * 0.66) !important;
    transform: none !important;
  }
  /* Sound selection buttons 50% smaller */
  #instButtons{ gap: 6px !important; }
  .instBtn{
    width: calc(var(--topH)) !important;
    height: calc(var(--topH)) !important;
    border-radius: 10px !important;
    border-width: 3px !important;
    box-shadow: 0 5px 0 rgba(0,0,0,0.07) !important;
    font-size: 14px !important;
  }
  .instBtn .waveIcon{ width: 18px !important; height: 13px !important; }

  /* Robot: 75% smaller, centered below sound buttons (moved into right column by JS on mobile) */
  body{ --robotSize: 55px; }
  body.loggedIn{ --robotSize: 55px; }
  #robotLogo{
    position: static !important;
    left: auto !important;
    top: auto !important;
    transform: none !important;
    margin: 10px 0 0 auto !important;
    width: var(--robotSize) !important;
    height: var(--robotSize) !important;
    padding: 6px !important;
    box-shadow: 0 6px 0 rgba(0,0,0,0.07) !important;
  }

  /* Beat selector: remove its box and move it closer to the grid; shrink the outer shell */
  #sequencerShell{
    padding: 6px !important;
    border-radius: 16px !important;
  }
  #drumPanel{
    margin-top: auto !important;
    border: none !important;
    background: transparent !important;
    box-shadow: none !important;
    padding: 0 !important;
    align-self: flex-end !important;
  }
  #drumControls{
    flex-direction: column !important;
    align-items: flex-end !important;
    justify-content: flex-start !important;
    gap: 6px !important;
  }
  .drumStyleGroup{
    flex-direction: column !important;
    align-items: flex-end !important;
    gap: 6px !important;
  }
  .drumMiniBtn,
  .drumStyleBtn{
    width: 40px !important;
    height: 40px !important;
    border-radius: 12px !important;
  }
  .drumMiniBtn{
    font-size: 18px !important;
    box-shadow: 0 5px 0 rgba(0,0,0,0.07) !important;
  }
  .drumStyleBtn{
    box-shadow: 0 5px 0 rgba(0,0,0,0.07) !important;
  }
  .drumIcon{
    width: 78% !important;
    height: 78% !important;
  }

  /* Right drawer: tempo + volume side-by-side; tempo elements ~40% smaller */
  #rightDrawerRow{
    display:flex !important;
    flex-direction: row !important;
    align-items: flex-start !important;
    justify-content: space-between !important;
    width: 100% !important;
  }
  #rightDrawerRow #tempoControls{
    transform: scale(0.6) !important;
    transform-origin: top left !important;
  }
  #rightDrawerRow #masterVolUI{
    margin-left: 10px !important;
  }

}

/* Default: these are mobile-only UI; keep hidden elsewhere */
#drawerOverlay,
.drawerHandle,
.drawer,
#mobileAuthGroup{ display:none; }

  </style>
</head>

<body>
  <div id="page">
    <div id="topBar">
<div id="titleBox"><div class="titleText">Kid Sequencer</div></div>
<div id="memberPill" aria-live="polite">Guest</div>
    </div>

    <div id="robotLogo" aria-hidden="true">
      <div class="robotClip">
        <img src="kid_Tech_Robot.svg" alt="" draggable="false" />
      </div>
    </div>

    <div id="contentWrap">
      <div id="controls">
        
        <button class="bigBtn iconBtn" onclick="play()" title="Play" aria-label="Play"><span class="icon playIcon"><svg viewBox="0 0 24 24" aria-hidden="true"><polygon points="8,5 20,12 8,19" fill="currentColor"/></svg></span></button>
        <button class="bigBtn iconBtn" onclick="stop()" title="Stop" aria-label="Stop"><span class="icon stopIcon"><svg viewBox="0 0 24 24" aria-hidden="true"><rect x="6.5" y="6.5" width="11" height="11" rx="1.5" fill="currentColor"/></svg></span></button>
        <button class="bigBtn iconBtn" onclick="clearGrid()" title="Clear" aria-label="Clear"><span class="icon clearIcon"><svg viewBox="0 0 24 24" aria-hidden="true">
  <path d="M9 3h6l1 2h4v2H4V5h4l1-2z" fill="currentColor"/>
  <path d="M7 9h10l-1 12H8L7 9z" fill="currentColor"/>
  <rect x="9.5" y="11" width="1.8" height="8" fill="#ffffff" opacity="0.6"/>
  <rect x="12.3" y="11" width="1.8" height="8" fill="#ffffff" opacity="0.6"/>
</svg></span></button>
        <button class="bigBtn iconBtn" onclick="undo()" title="Undo" aria-label="Undo"><span class="icon undoIcon"><svg viewBox="-2 -2 28 28" aria-hidden="true">
  <path d="M9 7H5V3" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
  <path d="M5 7c2-3 5-5 9-5 6 0 9 4 9 10 0 5-3 9-9 9-3 0-6-1-8-3" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
</svg></span></button>
        <button class="bigBtn iconBtn" id="cameraBtn" onclick="openCameraModal()" title="Scan" aria-label="Scan"><span class="icon cameraIcon"><svg viewBox="0 0 24 24" aria-hidden="true">
  <path d="M7 7l1.2-2h7.6L17 7h2.5c1.1 0 2 .9 2 2v10c0 1.1-.9 2-2 2H4.5c-1.1 0-2-.9-2-2V9c0-1.1.9-2 2-2H7z" fill="currentColor"/>
  <circle cx="12" cy="14" r="4" fill="#ffffff" opacity="0.9"/>
  <circle cx="12" cy="14" r="2.2" fill="currentColor" opacity="0.75"/>
</svg></span></button>
      </div>

      <div id="mainLayout">
        <div id="tools">
          <div id="toolsList"></div>
          <div id="toolsLoginArea">
            <div id="loginCtaWrap" aria-label="Login to unlock">
<a id="toolLoginBtn" class="loginBtn loginLink" href="login.html">Login</a>
            </div>
          </div>
        </div>

        <div id="sequencerShell">
          <div id="sequencerWrapper">
            <div id="playhead" style="display:none;"></div>
            <div id="sequencer"></div>
          </div>
          <div id="drumPanel" aria-label="Drum controls">
            <div id="drumControls">
              <button id="drumMuteBtn" class="drumMiniBtn muted" aria-pressed="false" title="Unmute drums">üîá</button>
              <div class="drumStyleGroup" role="group" aria-label="Drum style">
                <button id="drumStyleTech" class="drumStyleBtn selected" aria-pressed="true" title="Techno" aria-label="Techno">
                  <img class="drumIcon" src="techno_logo.svg" alt="Techno" />
                </button>
                <button id="drumStyleDnB" class="drumStyleBtn" aria-pressed="false" title="Drum n Bass" aria-label="Drum n Bass">
                  <img class="drumIcon" src="breakbeat_logo.svg" alt="Drum n Bass" />
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="rightCol">
          <div id="tempoControls" class="locked">
            <button id="tempoUpBtn" onclick="tempoUp()" aria-disabled="true">‚ñ≤</button>
            <div id="tempoBox" aria-disabled="true">120</div>
            <button id="tempoDownBtn" onclick="tempoDown()" aria-disabled="true">‚ñº</button>
</div>

          <div id="instButtons">
            <div class="instBtn" id="btnPiano"   title="Piano / Organ">üéπ</div>
            <div class="instBtn" id="btnTrumpet" title="Trumpet">üé∫</div>
            <div class="instBtn" id="btnStrings" title="Space">üåå</div>
            <div class="instBtn" id="btnSynth" title="Synth">
              <svg class="waveIcon" viewBox="0 0 120 70" aria-hidden="true">
                <polyline
                  points="5,55 25,15 25,55 45,15 45,55 65,15 65,55 85,15 85,55 105,15 105,55 115,40"
                  fill="none"
                  stroke="#1f6bff"
                  stroke-width="7"
                  stroke-linejoin="round"
                  stroke-linecap="round"
                />
              </svg>
            </div>
          </div>

          <div class="seqFaderRow" id="masterVolUI">
            <div class="seqFaderPanel" aria-label="Master volume fader (UI)">
              <div class="seqTrackArea" id="seqTrackArea">
                <div class="seqTrack"></div>

                
                <input id="seqVolRange" class="seqVolRange" type="range" min="0" max="10" step="0.01" value="10" aria-label="Master volume" />
<div class="seqIncTicks" aria-hidden="true">
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                  <div class="t"></div>
                </div>

                <div class="seqCaps" aria-hidden="true">
                  <div class="seqCap"></div>
                  <div class="seqCap"></div>
                </div>

                <div class="seqKnob" id="seqKnob" role="slider" aria-valuemin="0" aria-valuemax="10" aria-valuenow="8" tabindex="-1">
                  <div class="seqKnobStripe"></div>
                </div>
              </div>
            </div>

            <div class="seqReadout" aria-label="Volume display">
              <div class="small">VOL</div>
              <div class="num" id="seqVolNum">10</div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  
  <!-- Mobile landscape drawers + handles (mobile-only; hidden on desktop) -->
  <div id="drawerOverlay" aria-hidden="true"></div>
  <button id="leftDrawerHandle" class="drawerHandle left" type="button" aria-label="Open note lengths">‚â°</button>
  <button id="rightDrawerHandle" class="drawerHandle right" type="button" aria-label="Open tempo and volume">‚â°</button>

  <aside id="leftDrawer" class="drawer left" aria-hidden="true">
    <div class="drawerTop">
      <div class="drawerTitle">Note Length</div>
      <button class="drawerClose" type="button" data-close="left" aria-label="Close note length drawer">√ó</button>
    </div>
    <div id="leftDrawerContent" class="drawerContent"></div>
  </aside>

  <aside id="rightDrawer" class="drawer right" aria-hidden="true">
    <div class="drawerTop">
      <div class="drawerTitle">Tempo / Volume</div>
      <button class="drawerClose" type="button" data-close="right" aria-label="Close tempo and volume drawer">√ó</button>
    </div>
    <div id="rightDrawerContent" class="drawerContent"></div>
  </aside>

  <!-- Mobile auth group (pill + login/logout), positioned beside camera in mobile-landscape -->
  <div id="mobileAuthGroup" aria-live="polite"></div>


  <button id="logoutBtn" onclick="logout()" aria-label="Logout">Logout</button>

  <!-- Mobile portrait navigation tabs -->
  <div id="mobileTabs" role="tablist" aria-label="Mobile navigation">
    <button class="tabBtn" type="button" data-tab="grid" role="tab" aria-selected="true">Grid</button>
    <button class="tabBtn" type="button" data-tab="tools" role="tab" aria-selected="false">Tools</button>
    <button class="tabBtn" type="button" data-tab="sounds" role="tab" aria-selected="false">Sounds</button>
  </div>

  <div id="rotatePrompt">
    <div class="emoji">üì±‚ÜîÔ∏è</div>
    <div class="text">
      Turn your device sideways for the best view!
      <span class="sub">Landscape mode makes the grid easier to use.</span>
    </div>
  </div>


  <!-- Camera Scan Modal (required for the Scan button) -->
  <div id="camModal" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Camera Scan">
      <div class="modalHeader">
        <div class="modalTitle">Scan</div>
        <button class="modalClose" onclick="closeCameraModal()" aria-label="Close">√ó</button>
      </div>

      <div class="camStage">
        <video id="camVideo" autoplay playsinline muted></video>
        <img id="camPreview" alt="Capture preview" />
        <canvas id="camCanvas" style="display:none;"></canvas>
        <div class="camOverlay"></div>
      </div>

      <div class="modalBtns">
        <button class="bigBtn" onclick="camCapture()">Capture</button>
        <button class="bigBtn" onclick="camImport()">Use</button>
        <button class="bigBtn" onclick="closeCameraModal()">Close</button>
      </div>
      <div class="modalHint">Tip: line the grid up inside the dashed box.</div>
    </div>
  </div>

<script>
/* OPTION A ORGANISATION START */
// This file is intentionally single-file, but the JS is grouped into logical modules.
// Layout + behavior are unchanged; we only add structure + a small public API.
(() => {
/* Option A: single-file organisation (no layout/behaviour changes) */


/* -------------------- CONFIG -------------------- */
const rows = 8;
const cols = 16;

let CELL = 46;
const GAP  = 4;

const freqs = [523.25,493.88,440.00,392.00,349.23,329.63,293.66,261.63];
const rowColors = ["#FF0000","#FF4FD8","#7A5CFF","#3DA9FF","#00FF00","#FFFF00","#FF8C00","#FF0000"];

const toolSteps = [
  { steps: 1,  label: "16th",  symbol: "‚ô¨", divs: 16, symClass:"sixteenth" },
  { steps: 2,  label: "8th",   symbol: "‚ô™", divs: 8,  symClass:"eighth" },
  { steps: 4,  label: "1/4",   symbol: "‚ô©", divs: 4,  symClass:"normal" },
  { steps: 8,  label: "1/2",   symbol: "ùÖû", divs: 2,  symClass:"normal" },
  { steps: 16, label: "Whole", symbol: "ùÖù", divs: 1,  symClass:"normal" }
];

let selectedSteps = 1;

let isLoggedIn = false;
try{ isLoggedIn = localStorage.getItem("kidseq_logged_in") === "1"; }catch(e){ isLoggedIn = false; }
const LOCKED_STEPS = new Set([4,8,16]);

/* -------------------- STATE -------------------- */
let notesByRow = Array.from({length: rows}, () => []);
let occ = Array.from({length: rows}, () => Array(cols).fill(null));

let audioCtx = null;
let tempo = 120;
let pendingTempo = null;
let step = 0;
let timer = null;

let masterGain = null;
let masterComp = null;

let startTimeout = null;
let audioPrimed = false;
let hasEverStartedPlayback = false;
let lastStopAt = null;

/* track when audio last actually made a sound */
let lastAudioActivityAt = null;

const liveNodes = new Set();
let bus = null;

let instrument = "piano";

/* -------------------- DRUMS -------------------- */
let drumsMuted = true;            // start muted
let drumStyle = "techhouse";      // techhouse | dnb
let drumBus = null;               // GainNode
let drumNoise = null;             // AudioBuffer

const DRUM_PATTERNS = {
  techhouse: {
    // 4-on-the-floor + claps on 2 & 4 + driving hats
    kick: [1,0,0,0,  1,0,0,0,  1,0,0,0,  1,0,0,0],
    clap: [0,0,0,0,  1,0,0,0,  0,0,0,0,  1,0,0,0],
    // closed hat: 16ths with gentle accents
    hatC: [0.26,0.14,0.20,0.14,  0.26,0.14,0.20,0.14,  0.26,0.14,0.20,0.14,  0.26,0.14,0.20,0.14],
    // open hat: offbeats (the "and")
    hatO: [0,0,0.24,0,  0,0,0.24,0,  0,0,0.24,0,  0,0,0.24,0],
  },
  dnb: {
    // classic DnB feel: snare on 2 & 4, syncopated kicks, fast hats
    kick:  [1,0,0,0,  0,0,0,0,  0,0,1,0,  0,0,0,0],
    snare: [0,0,0,0,  1,0,0,0,     0,0,0,0,     1,0,0,0],
    hatC:  [0.20,0.14,0.20,0.14,  0.22,0.14,0.20,0.14,  0.20,0.14,0.24,0.14,  0.20,0.14,0.20,0.14],
    // occasional open hat stabs
    hatO:  [0,0,0,0,   0,0,0,0.18,  0,0,0,0,   0,0.18,0,0]
  }
};

const LEVEL = {
  piano:   0.60,
  trumpet: 1.18,
  strings: 1.30,
  synth:   0.55
};

/* Undo history (max 10 user actions) */
const undoStack = [];
const UNDO_MAX = 10;

function cloneState(){
  return {
    notesByRow: notesByRow.map(row => row.map(n => ({ id:n.id, start:n.start, len:n.len }))),
    occ: occ.map(row => row.slice()),
    nextId
  };
}
function pushUndo(){
  undoStack.push(cloneState());
  while(undoStack.length > UNDO_MAX) undoStack.shift();
}
function undo(){
  if(!undoStack.length) return;
  const snap = undoStack.pop();
  notesByRow = snap.notesByRow.map(row => row.map(n => ({...n})));
  occ = snap.occ.map(row => row.slice());
  nextId = snap.nextId;
  redrawAllNotes();
}

/* DOM */
const tempoBox = document.getElementById("tempoBox");
const sequencerEl = document.getElementById("sequencer");
const toolsEl = document.getElementById("tools");
const toolsListEl = document.getElementById("toolsList");
const toolLoginBtnEl = document.getElementById("toolLoginBtn");
const logoutBtnEl = document.getElementById("logoutBtn");


const tempoControlsEl = document.getElementById("tempoControls");
const tempoUpBtnEl = document.getElementById("tempoUpBtn");
const tempoDownBtnEl = document.getElementById("tempoDownBtn");
const instButtonsEl = document.getElementById("instButtons");
const playheadEl = document.getElementById("playhead");
const rotatePromptEl = document.getElementById("rotatePrompt");
const controlsEl = document.getElementById("controls");
const mainLayoutEl = document.getElementById("mainLayout");
const titleBoxEl = document.getElementById("titleBox");

const cameraBtnEl = document.getElementById("cameraBtn");

const btnPiano   = document.getElementById("btnPiano");
const btnTrumpet = document.getElementById("btnTrumpet");
const btnStrings = document.getElementById("btnStrings");
const btnSynth   = document.getElementById("btnSynth");

/* Drums UI */
const drumMuteBtnEl = document.getElementById("drumMuteBtn");
const drumStatusEl  = document.getElementById("drumStatus");
const drumStyleTechEl = document.getElementById("drumStyleTech");
const drumStyleDnBEl  = document.getElementById("drumStyleDnB");

btnPiano.onclick   = () => { if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; } ensureAudioRunning(); setInstrument("piano"); };
btnTrumpet.onclick = () => { if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; } ensureAudioRunning(); setInstrument("trumpet"); };
btnStrings.onclick = () => { if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; } ensureAudioRunning(); setInstrument("strings"); };
btnSynth.onclick   = () => { if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; } ensureAudioRunning(); setInstrument("synth"); };


/* -------------------- DRUMS UI -------------------- */
function setDrumsMuted(m){
  drumsMuted = !!m;

  if(drumMuteBtnEl){
    drumMuteBtnEl.classList.toggle("muted", drumsMuted);
    drumMuteBtnEl.textContent = drumsMuted ? "üîá" : "üîä";
    drumMuteBtnEl.setAttribute("aria-pressed", String(!drumsMuted));
    drumMuteBtnEl.title = drumsMuted ? "Unmute drums" : "Mute drums";
  }

  // If audio is running, fade the drum bus smoothly
  if(audioCtx && drumBus){
    const now = audioCtx.currentTime;
    const target = drumsMuted ? 0.0001 : 0.92;
    try{
      drumBus.gain.cancelScheduledValues(now);
      drumBus.gain.setValueAtTime(drumBus.gain.value, now);
      drumBus.gain.linearRampToValueAtTime(target, now + 0.03);
    }catch(e){}
  }
}

function setDrumStyle(style){
  drumStyle = (style === "dnb") ? "dnb" : "techhouse";
  if(drumStyleTechEl && drumStyleDnBEl){
    const isTech = drumStyle === "techhouse";
    drumStyleTechEl.classList.toggle("selected", isTech);
    drumStyleDnBEl.classList.toggle("selected", !isTech);
    drumStyleTechEl.setAttribute("aria-pressed", String(isTech));
    drumStyleDnBEl.setAttribute("aria-pressed", String(!isTech));
  }
}

if(drumMuteBtnEl){
  drumMuteBtnEl.onclick = () => {
    // Ensure audio exists if the user unmutes while playing.
    getAudio();
    ensureAudioRunning();
    setDrumsMuted(!drumsMuted);
  };
}
if(drumStyleTechEl) drumStyleTechEl.onclick = () => setDrumStyle("techhouse");
if(drumStyleDnBEl)  drumStyleDnBEl.onclick  = () => setDrumStyle("dnb");

// Init (starts muted)
setDrumStyle(drumStyle);
setDrumsMuted(true);

/* -------------------- LOCKED UI (Login nudges) -------------------- */
const loginCtaWrapEl = document.getElementById("loginCtaWrap");

let lockNudgeHideT = null;
function showLockNudge(){
  if(!loginCtaWrapEl) return;
  clearTimeout(lockNudgeHideT);
  loginCtaWrapEl.classList.add("pulsing");
}
function hideLockNudgeSoon(ms=0){
  if(!loginCtaWrapEl) return;
  clearTimeout(lockNudgeHideT);
  lockNudgeHideT = setTimeout(() => {
    loginCtaWrapEl.classList.remove("pulsing");
  }, ms);
}
function bindLockedNudge(el){
  if(!el) return;
  el.addEventListener("mouseenter", () => { if(!isLoggedIn) showLockNudge(); });
  el.addEventListener("mouseleave", () => { if(!isLoggedIn) hideLockNudgeSoon(0); });
  el.addEventListener("pointerdown", () => { if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); } }, { passive:true });
}

/* Make login links return to this page */
function updateLoginLinks(){
  const current = (location.pathname.split("/").pop() || "index.html");
  document.querySelectorAll("a.loginLink").forEach(a => {
    a.href = "login.html?return=" + encodeURIComponent(current);
  });
}
updateLoginLinks();

function applyLockState(){
  const locked = !isLoggedIn;
  const robotLogoEl = document.getElementById("robotLogo");
  if(robotLogoEl) robotLogoEl.style.display = "flex";

  // If we just moved into Guest/locked mode and a locked note-length was selected,
  // bump back to a free length (16th).
  if(locked && typeof LOCKED_STEPS !== "undefined" && LOCKED_STEPS.has(selectedSteps)){
    selectedSteps = 1;
  }

  // Rebuild tool buttons so their locked state updates on login/logout.
  try{ buildTools(); }catch(e){}

  if(tempoControlsEl) tempoControlsEl.classList.toggle("locked", locked);
  if(instButtonsEl) instButtonsEl.classList.toggle("locked", locked);
  if(cameraBtnEl) cameraBtnEl.classList.toggle("locked", locked);
  document.body.classList.toggle("loggedIn", isLoggedIn);

  try{ positionRobotLogo(); }catch(e){}
}
applyLockState();

// Ensure the correct state when the browser restores the page from cache
window.addEventListener('pageshow', () => {
  try{ isLoggedIn = localStorage.getItem('kidseq_logged_in') === '1'; }catch(e){ isLoggedIn = false; }
  if(loginCtaWrapEl) loginCtaWrapEl.classList.remove('pulsing');
  applyLockState();
});

function logout(){
  try{ localStorage.removeItem('kidseq_logged_in'); }catch(e){}
  try{ localStorage.removeItem('kidseq_user_email'); }catch(e){}
  isLoggedIn = false;
  try{ stop(); }catch(e){}

  // Restore the locked/landing UI immediately
  if(loginCtaWrapEl) loginCtaWrapEl.classList.remove('pulsing');
  applyLockState();
  updateLoginLinks();

  requestAnimationFrame(() => {
    try{ fitToViewport(); }catch(e){}
    try{ positionRobotLogo(); }catch(e){}
  });
}


/* Bind hover nudges for locked groups */
bindLockedNudge(cameraBtnEl);
bindLockedNudge(tempoUpBtnEl);
bindLockedNudge(tempoDownBtnEl);
bindLockedNudge(tempoBox);

[btnPiano, btnTrumpet, btnStrings, btnSynth].forEach(bindLockedNudge);

/* Prime audio */
function primeAudioOnce(){
  if (audioPrimed) return;
  audioPrimed = true;
  getAudio();
}
window.addEventListener("pointerdown", primeAudioOnce, { once: true, passive: true });
window.addEventListener("keydown", primeAudioOnce, { once: true });

/* Prevent focus caret */
window.addEventListener("pointerdown", () => {
  if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
}, { passive: true });

/* Spacebar start/stop */
window.addEventListener("keydown", (e) => {
  if (e.code !== "Space") return;
  e.preventDefault();
  if (timer || startTimeout) stop();
  else play();
});

/* -------------------- PLAYHEAD WOBBLE SCALING -------------------- */
function clamp01(x){ return Math.max(0, Math.min(1, x)); }
function setPlayheadWobbleFromTempo(t){
  const ratio = (t >= 90) ? 1 : clamp01((t - 40) / (90 - 40));
  document.documentElement.style.setProperty("--wiggleDeg",   (1.2 * ratio).toFixed(3) + "deg");
  document.documentElement.style.setProperty("--wiggleScale", (0.01 * ratio).toFixed(4));
}

/* -------------------- RESPONSIVE FIT -------------------- */
function fitToViewport(){
  const vw = Math.max(320, window.innerWidth);
  const vh = Math.max(480, window.innerHeight);

  const headerH = 92;
  const controlsH = 70;
  const vMargins = 26;
  const gridExtra = 26;

  let toolW = Math.min(220, Math.max(160, Math.floor(vw * 0.30)));
  let rightW = Math.min(120, Math.max(100, Math.floor(vw * 0.18)));

  const outerPadding = 28;
  const gaps = 14 * 2;
  const maxCellByWidth = Math.floor(
    (vw - toolW - rightW - outerPadding - gaps - (cols - 1) * GAP - gridExtra) / cols
  );

  const availableH = vh - headerH - controlsH - vMargins - gridExtra;
  const maxCellByHeight = Math.floor((availableH - (rows - 1) * GAP) / rows);

  let cell = Math.min(maxCellByWidth, maxCellByHeight);
  cell = Math.max(26, Math.min(56, cell));

  if(cell <= 34){
    toolW = Math.max(150, Math.floor(vw * 0.28));
    rightW = Math.max(96, Math.floor(vw * 0.16));
  }

  document.documentElement.style.setProperty("--toolW", toolW + "px");
  document.documentElement.style.setProperty("--rightW", rightW + "px");
  document.documentElement.style.setProperty("--cell", cell + "px");
  CELL = cell;

  const toolsRect = toolsEl.getBoundingClientRect();
  const pageLeft = 14;
  document.documentElement.style.setProperty("--titleInset", Math.max(0, Math.round(toolsRect.left - pageLeft)) + "px");

  const controlsRect = controlsEl.getBoundingClientRect();
  const mainRect = mainLayoutEl.getBoundingClientRect();
  document.documentElement.style.setProperty("--rightLift", Math.max(0, Math.round(mainRect.top - controlsRect.top)) + "px");

  const playBtn = controlsEl.querySelector(".bigBtn");
  if (playBtn) {
    const currentLift = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--contentLift")) || 0;

    const playRect  = playBtn.getBoundingClientRect();
    const titleRect = titleBoxEl.getBoundingClientRect();

    const playCenter  = playRect.top  + playRect.height / 2;
    const titleCenter = titleRect.top + titleRect.height / 2;

    const delta = Math.round(playCenter - titleCenter);
    let newLift = Math.round(currentLift + delta);
    newLift = Math.max(0, Math.min(260, newLift));
    document.documentElement.style.setProperty("--contentLift", newLift + "px");
  }

  const portrait = vh > vw * 1.05;
  const phoneish = vw < 820;
  rotatePromptEl.style.display = (portrait && phoneish) ? "flex" : "none";
}

function positionRobotLogo(){
  const logo = document.getElementById('robotLogo');
  const page = document.getElementById('page');
  const toolsList = document.getElementById('toolsList');
  const toolsCol = document.getElementById('tools');
  const rightCol = document.getElementById('rightCol');
  const loginWrap = document.getElementById('loginCtaWrap');
  const seqWrap = document.getElementById('sequencerWrapper') || document.getElementById('sequencer');
  if(!logo || !page || !seqWrap) return;

  const sx = window.scrollX || window.pageXOffset || 0;
  const sy = window.scrollY || window.pageYOffset || 0;
  const pageRect = page.getBoundingClientRect();
  const pageX = pageRect.left + sx;
  const pageY = pageRect.top  + sy;

  const toPage = (r) => ({
    left:   r.left   + sx - pageX,
    right:  r.right  + sx - pageX,
    top:    r.top    + sy - pageY,
    bottom: r.bottom + sy - pageY,
    width:  r.width,
    height: r.height
  });

  const gridRect = toPage(seqWrap.getBoundingClientRect());
  const toolsListRect = (toolsList ? toPage(toolsList.getBoundingClientRect()) : {left:0, top:0, bottom:0, width:0, height:0});
  const toolsRect = (toolsCol ? toPage(toolsCol.getBoundingClientRect()) : toolsListRect);
  const rightRect = (rightCol ? toPage(rightCol.getBoundingClientRect()) : gridRect);

  const desired = Math.round((parseFloat(getComputedStyle(document.body).getPropertyValue('--robotSize')) || 180));
  const isPortraitTabs = window.matchMedia('(max-width: 820px) and (orientation: portrait)').matches;
  const activeTab = (document.body.dataset.mobileTab || 'grid').toLowerCase();

  // Choose an anchor based on what's visible (important in mobile tab mode)
  let anchorRect = gridRect;
  if(isPortraitTabs){
    if(activeTab === 'tools') anchorRect = (toolsListRect.width > 10 ? toolsListRect : toolsRect);
    else if(activeTab === 'sounds') anchorRect = rightRect;
    else anchorRect = gridRect;
  }

  // Vertical constraints
  let topMin;
  if(isPortraitTabs && activeTab !== 'grid'){
    topMin = anchorRect.top + 10;
  } else {
    topMin = (toolsListRect.width > 10 ? toolsListRect.bottom + 18 : anchorRect.top + 10);
  }

  if(loginWrap){
    const r = toPage(loginWrap.getBoundingClientRect());
    if(r.width > 0 && r.height > 0) topMin = Math.max(topMin, r.bottom + 28);
  }

  const bottom = anchorRect.bottom;
  const avail = Math.floor(bottom - topMin);
  if (avail < 40) return;

  const size = Math.max(40, Math.min(desired, avail));

  // Apply size (and scale padding so it stays "button-like")
  logo.style.width  = size + 'px';
  logo.style.height = size + 'px';
  logo.style.padding = Math.round(size * 0.12) + 'px';

  // Horizontal placement
  let xCenter;
  if(!isPortraitTabs && toolsListRect.width > 10){
    xCenter = toolsListRect.left + toolsListRect.width / 2;
  } else if(isPortraitTabs && activeTab === 'grid'){
    // Put it on the left edge of the grid in portrait (no left tool column)
    xCenter = gridRect.left + (size / 2) + 12;
  } else {
    xCenter = anchorRect.left + anchorRect.width / 2;
  }

  const nudgeY = 6;
  const top = Math.round(bottom - size + nudgeY);
  logo.style.left = Math.round(xCenter - size/2) + 'px';
  logo.style.top  = Math.max(Math.round(topMin), top) + 'px';
}

function setupMobileTabs(){
  const tabs = document.getElementById('mobileTabs');
  if(!tabs) return;
  const btns = Array.from(tabs.querySelectorAll('.tabBtn'));
  if(btns.length === 0) return;

  const setTab = (tab) => {
    const t = (tab || 'grid').toLowerCase();
    document.body.dataset.mobileTab = t;
    btns.forEach(b => {
      const on = (b.dataset.tab || '').toLowerCase() === t;
      b.classList.toggle('active', on);
      b.setAttribute('aria-selected', on ? 'true' : 'false');
    });

    requestAnimationFrame(() => {
      fitToViewport();
      buildGrid();
      positionRobotLogo();
    });
  };

  // Default tab
  if(!document.body.dataset.mobileTab) setTab('grid');
  else setTab(document.body.dataset.mobileTab);

  tabs.addEventListener('click', (e) => {
    const b = e.target && e.target.closest ? e.target.closest('.tabBtn') : null;
    if(!b) return;
    setTab(b.dataset.tab);
  });

  // Re-apply styling on orientation changes
  window.addEventListener('orientationchange', () => {
    setTimeout(() => setTab(document.body.dataset.mobileTab || 'grid'), 60);
  });
}


window.addEventListener("resize", () => {
  requestAnimationFrame(() => {
    fitToViewport();
    buildGrid();
    positionRobotLogo();
  });
});

/* -------------------- AUDIO -------------------- */
function ensureAudioRunning(){
  if (!audioCtx) return;
  if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
}

function trackNode(node){
  liveNodes.add(node);
  node.onended = () => liveNodes.delete(node);
}

function makeHallImpulse(ctx, seconds, decay){
  const rate = ctx.sampleRate;
  const length = Math.floor(rate * seconds);
  const impulse = ctx.createBuffer(2, length, rate);
  for(let ch=0; ch<2; ch++){
    const data = impulse.getChannelData(ch);
    for(let i=0;i<length;i++){
      const t = i / length;
      const env = Math.pow(1 - t, decay);
      data[i] = (Math.random()*2 - 1) * env * (ch === 0 ? 1 : 0.96);
    }
  }
  return impulse;
}

function makeNoiseBuffer(ctx){
  const len = Math.max(1, Math.floor(ctx.sampleRate * 1.0));
  const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const data = buf.getChannelData(0);
  for(let i=0;i<len;i++) data[i] = (Math.random() * 2 - 1);
  return buf;
}

function playKick(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;

  // Main body
  const osc = ctx.createOscillator();
  const g = ctx.createGain();

  osc.type = "sine";
  // Faster, deeper sweep = more punch
  osc.frequency.setValueAtTime(190, at);
  osc.frequency.exponentialRampToValueAtTime(62, at + 0.065);
  osc.frequency.exponentialRampToValueAtTime(48, at + 0.135);

  // Envelope
  const peak = 1.10 * vel;
  g.gain.setValueAtTime(0.0001, at);
  g.gain.exponentialRampToValueAtTime(peak, at + 0.003);
  g.gain.exponentialRampToValueAtTime(0.0001, at + 0.17);

  // Short tonal transient (no noise "click")
  const tosc = ctx.createOscillator();
  const tg = ctx.createGain();
  tosc.type = "triangle";
  tosc.frequency.setValueAtTime(320, at);
  tosc.frequency.exponentialRampToValueAtTime(140, at + 0.030);

  tg.gain.setValueAtTime(0.0001, at);
  tg.gain.exponentialRampToValueAtTime(0.22 * vel, at + 0.0015);
  tg.gain.exponentialRampToValueAtTime(0.0001, at + 0.030);

  // Mild saturation to make it feel punchier
  const shaper = ctx.createWaveShaper();
  shaper.oversample = "4x";
  const N = 256;
  const curve = new Float32Array(N);
  const amt = 2.0;
  for(let i=0;i<N;i++){
    const x = (i / (N - 1)) * 2 - 1;
    curve[i] = Math.tanh(amt * x);
  }
  shaper.curve = curve;

  const lp = ctx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.setValueAtTime(9000, at);
  lp.Q.setValueAtTime(0.7, at);

  osc.connect(g);
  g.connect(shaper);

  tosc.connect(tg);
  tg.connect(shaper);

  shaper.connect(lp);
  lp.connect(drumBus);

  trackNode(osc);
  trackNode(tosc);

  osc.start(at);
  osc.stop(at + 0.22);

  tosc.start(at);
  tosc.stop(at + 0.06);
}

function playPerc(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;
  const osc = ctx.createOscillator();
  const g = ctx.createGain();

  osc.type = "triangle";
  osc.frequency.setValueAtTime(320, at);
  osc.frequency.exponentialRampToValueAtTime(170, at + 0.06);

  const peak = 0.22 * vel;
  g.gain.setValueAtTime(0.0001, at);
  g.gain.exponentialRampToValueAtTime(peak, at + 0.004);
  g.gain.exponentialRampToValueAtTime(0.0001, at + 0.10);

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(520, at);
  bp.Q.setValueAtTime(2.2, at);

  osc.connect(bp);
  bp.connect(g);
  g.connect(drumBus);

  trackNode(osc);
  osc.start(at);
  osc.stop(at + 0.14);
}

function playSnare(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;

  const src = ctx.createBufferSource();
  src.buffer = drumNoise || makeNoiseBuffer(ctx);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(700, at);

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(1800, at);
  bp.Q.setValueAtTime(0.9, at);

  const g = ctx.createGain();
  const peak = 0.42 * vel;
  g.gain.setValueAtTime(0.0001, at);
  g.gain.exponentialRampToValueAtTime(peak, at + 0.003);
  g.gain.exponentialRampToValueAtTime(0.0001, at + 0.13);

  src.connect(hp);
  hp.connect(bp);
  bp.connect(g);
  g.connect(drumBus);

  // Small tonal body
  const body = ctx.createOscillator();
  body.type = "triangle";
  body.frequency.setValueAtTime(210, at);
  body.frequency.exponentialRampToValueAtTime(150, at + 0.09);

  const bg = ctx.createGain();
  bg.gain.setValueAtTime(0.0001, at);
  bg.gain.exponentialRampToValueAtTime(0.10 * vel, at + 0.004);
  bg.gain.exponentialRampToValueAtTime(0.0001, at + 0.10);

  body.connect(bg);
  bg.connect(drumBus);

  trackNode(src);
  trackNode(body);

  src.start(at);
  src.stop(at + 0.18);

  body.start(at);
  body.stop(at + 0.14);
}

function playClap(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;
  const bursts = [0.0, 0.014, 0.028];

  for(let i=0;i<bursts.length;i++){
    const t = at + bursts[i];

    const src = ctx.createBufferSource();
    src.buffer = drumNoise || makeNoiseBuffer(ctx);

    const hp = ctx.createBiquadFilter();
    hp.type = "highpass";
    hp.frequency.setValueAtTime(950, t);

    const bp = ctx.createBiquadFilter();
    bp.type = "bandpass";
    bp.frequency.setValueAtTime(2100, t);
    bp.Q.setValueAtTime(0.8, t);

    const g = ctx.createGain();
    const peak = (i == 0 ? 0.32 : 0.22) * vel;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(peak, t + 0.002);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.055);

    src.connect(hp);
    hp.connect(bp);
    bp.connect(g);
    g.connect(drumBus);

    trackNode(src);
    src.start(t);
    src.stop(t + 0.10);
  }
}

function playHatClosed(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;

  const src = ctx.createBufferSource();
  src.buffer = drumNoise || makeNoiseBuffer(ctx);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(7200, at);

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(9400, at);
  bp.Q.setValueAtTime(0.7, at);

  const g = ctx.createGain();
  const peak = 0.18 * vel;
  g.gain.setValueAtTime(0.0001, at);
  g.gain.exponentialRampToValueAtTime(peak, at + 0.001);
  g.gain.exponentialRampToValueAtTime(0.0001, at + 0.045);

  src.connect(hp);
  hp.connect(bp);
  bp.connect(g);
  g.connect(drumBus);

  trackNode(src);
  src.start(at);
  src.stop(at + 0.08);
}

function playHatOpen(at, vel=1){
  if(!audioCtx || !drumBus) return;
  lastAudioActivityAt = performance.now();

  const ctx = audioCtx;

  const src = ctx.createBufferSource();
  src.buffer = drumNoise || makeNoiseBuffer(ctx);

  const hp = ctx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(6000, at);

  const bp = ctx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(8600, at);
  bp.Q.setValueAtTime(0.6, at);

  const g = ctx.createGain();
  const peak = 0.16 * vel;
  g.gain.setValueAtTime(0.0001, at);
  g.gain.exponentialRampToValueAtTime(peak, at + 0.002);
  g.gain.exponentialRampToValueAtTime(0.0001, at + 0.20);

  src.connect(hp);
  hp.connect(bp);
  bp.connect(g);
  g.connect(drumBus);

  trackNode(src);
  src.start(at);
  src.stop(at + 0.26);
}

function playDrumsAtStep(s){
  if(drumsMuted) return;
  if(!audioCtx || !drumBus) return;

  const pat = DRUM_PATTERNS[drumStyle] || DRUM_PATTERNS.techhouse;
  const stepDur = stepDurationSec();

  // Subtle shuffle for Tech-House hats only (keeps the playhead/grid exact)
  const swing = (drumStyle === "techhouse") ? 0.08 : 0.0;
  const offs = ((drumStyle === "techhouse") && (s % 2 === 1)) ? (stepDur * swing) : 0;

  const t = audioCtx.currentTime + 0.002 + offs;

  const k = (pat.kick && pat.kick[s]) ? pat.kick[s] : 0;
  if(k > 0) playKick(t, k);

  if(drumStyle === "techhouse"){
    const c = (pat.clap && pat.clap[s]) ? pat.clap[s] : 0;
    if(c > 0) playClap(t, c);
  }else{
    const sn = (pat.snare && pat.snare[s]) ? pat.snare[s] : 0;
    if(sn > 0) playSnare(t, sn);
  }

  const hc = (pat.hatC && pat.hatC[s]) ? pat.hatC[s] : 0;
  if(hc > 0) playHatClosed(t, hc);

  const ho = (pat.hatO && pat.hatO[s]) ? pat.hatO[s] : 0;
  if(ho > 0) playHatOpen(t, ho);
}

function makeInstrumentBuses(ctx, masterOut){
  const pianoIR   = makeHallImpulse(ctx, 1.60, 2.4);
  const trumpetIR = makeHallImpulse(ctx, 0.70, 2.0);
  const stringsIR = makeHallImpulse(ctx, 1.30, 2.5);
  const synthIR   = makeHallImpulse(ctx, 0.45, 2.0);

  function buildBus(ir, dryAmt, wetAmt){
    const input = ctx.createGain();

    const dry = ctx.createGain();
    dry.gain.value = dryAmt;

    const wet = ctx.createGain();
    wet.gain.value = wetAmt;

    const conv = ctx.createConvolver();
    conv.buffer = ir;

    input.connect(dry);
    input.connect(conv);
    conv.connect(wet);

    dry.connect(masterOut);
    wet.connect(masterOut);

    return { input };
  }

  return {
    piano:   buildBus(pianoIR,   0.72, 0.46),
    trumpet: buildBus(trumpetIR, 0.90, 0.12),
    strings: buildBus(stringsIR, 0.76, 0.32),
    synth:   buildBus(synthIR,   0.92, 0.12)
  };
}

function getAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    
    window.audioCtx = audioCtx;
masterGain = audioCtx.createGain();
    
    window.masterGain = masterGain;
masterGain.gain.setValueAtTime(1, audioCtx.currentTime);

    masterComp = audioCtx.createDynamicsCompressor();
    masterComp.threshold.setValueAtTime(-18, audioCtx.currentTime);
    masterComp.knee.setValueAtTime(18, audioCtx.currentTime);
    masterComp.ratio.setValueAtTime(3.4, audioCtx.currentTime);
    masterComp.attack.setValueAtTime(0.004, audioCtx.currentTime);
    masterComp.release.setValueAtTime(0.12, audioCtx.currentTime);

    masterGain.connect(masterComp);
    masterComp.connect(audioCtx.destination);

    bus = makeInstrumentBuses(audioCtx, masterGain);

    // Drums: dedicated bus (starts muted)
    drumBus = audioCtx.createGain();
    drumBus.gain.setValueAtTime(drumsMuted ? 0.0001 : 0.92, audioCtx.currentTime);
    drumBus.connect(masterGain);

    // Shared noise buffer for hats/snare/claps
    drumNoise = makeNoiseBuffer(audioCtx);

    warmUpAudio(2);
  }
  ensureAudioRunning();
}

function warmUpAudio(pulses = 2){
  if(!audioCtx || !masterGain) return;
  const now = audioCtx.currentTime;

  for(let i=0;i<pulses;i++){
    const t0 = now + i * 0.03;

    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    g.gain.setValueAtTime(0.0004, t0);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.02);

    osc.type = "sine";
    osc.frequency.setValueAtTime(220, t0);

    osc.connect(g);
    g.connect(masterGain);

    trackNode(osc);
    osc.start(t0);
    osc.stop(t0 + 0.03);
  }
}

function hardResetAudioEngine(){
  try{
    if(audioCtx){
      try { audioCtx.close(); } catch(e){}
    }
  }catch(e){}

  audioCtx = null;
  masterGain = null;
  masterComp = null;
  bus = null;
  drumBus = null;
  drumNoise = null;

  for(const n of Array.from(liveNodes)){
    try { n.stop(0); } catch(e){}
    liveNodes.delete(n);
  }

  getAudio();
  warmUpAudio(4);
}

function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

async function ensureAudioReady(){
  getAudio();

  const nowMs = performance.now();
  const audioIdleMs = (lastAudioActivityAt == null) ? Infinity : (nowMs - lastAudioActivityAt);

  if(audioIdleMs > 25000){
    hardResetAudioEngine();
  }

  if(!audioCtx) return;

  try{
    if(audioCtx.state !== "running"){
      const p = audioCtx.resume();
      await p;
    }
  }catch(e){}

  const t1 = audioCtx.currentTime;
  await sleep(40);
  const t2 = audioCtx.currentTime;

  if(!(t2 > t1 + 0.0005)){
    hardResetAudioEngine();
    if(audioCtx){
      try{
        if(audioCtx.state !== "running") await audioCtx.resume();
      }catch(e){}
      warmUpAudio(4);
    }
  }else{
    warmUpAudio(2);
  }
}

function stopAllAudioNow(){
  if(!audioCtx || !masterGain) return;

  for (const n of Array.from(liveNodes)){
    try { n.stop(0); } catch(e) {}
    liveNodes.delete(n);
  }

  const now = audioCtx.currentTime;
  masterGain.gain.cancelScheduledValues(now);
  masterGain.gain.setValueAtTime(masterGain.gain.value, now);
  masterGain.gain.linearRampToValueAtTime(0.0001, now + 0.02);
  masterGain.gain.setValueAtTime(1, now + 0.03);
}

function stepDurationSec(){
  return (60 / tempo) / 4;
}

/* -------------------- INSTRUMENT UI -------------------- */
function setInstrument(name){
  instrument = name;

  const all = [btnPiano, btnTrumpet, btnStrings, btnSynth];
  all.forEach(b => { b.classList.remove("selected","notSelected"); });

  const map = { piano: btnPiano, trumpet: btnTrumpet, strings: btnStrings, synth: btnSynth };
  const selected = map[name];
  selected.classList.add("selected");
  all.forEach(b => { if(b !== selected) b.classList.add("notSelected"); });
}

/* -------------------- TOOLS UI -------------------- */
function buildTools(){
  if(!toolsListEl) return;
  toolsListEl.innerHTML = "";

  toolSteps.forEach((t) => {
    const tool = document.createElement("div");
    tool.className = "tool";

    const isLocked = (!isLoggedIn) && LOCKED_STEPS.has(t.steps);
    if(isLocked){
      tool.classList.add("locked");
      tool.setAttribute("aria-disabled","true");
    }

    const sym = document.createElement("div");
    sym.className = "toolSymbol " + (t.symClass || "");
    sym.textContent = t.symbol;

    const barWrap = document.createElement("div");
    barWrap.className = "toolBarWrap";

    const bar = document.createElement("div");
    bar.className = "toolBar";
    bar.style.setProperty("--fill", (t.steps / 16).toFixed(4));
    bar.style.setProperty("--divs", String(t.divs));

    const fill = document.createElement("div");
    fill.className = "toolBarFill";

    const divs = document.createElement("div");
    divs.className = "toolBarDivs";
    if(t.steps === 16) divs.style.display = "none";

    bar.appendChild(fill);
    bar.appendChild(divs);

    const lab = document.createElement("div");
    lab.className = "toolLabel";
    lab.textContent = t.label;
    if(t.steps === 16) lab.classList.add("comicWhole");

    barWrap.appendChild(bar);
    barWrap.appendChild(lab);

    tool.appendChild(sym);
    tool.appendChild(barWrap);

        if(isLocked){
      bindLockedNudge(tool);
    }
    tool.onclick = () => {
      if(isLocked){
        showLockNudge();
        hideLockNudgeSoon(900);
        return;
      }
      selectedSteps = t.steps;
      toolsListEl.querySelectorAll(".tool").forEach(x => x.classList.remove("selected"));
      tool.classList.add("selected");
    };

    if(t.steps === selectedSteps) tool.classList.add("selected");
    toolsListEl.appendChild(tool);
  });
}

/* -------------------- GRID -------------------- */
let noteLayerEls = [];
let nextId = 1;

function buildGrid(){
  sequencerEl.innerHTML = "";
  noteLayerEls = [];

  for(let r=0;r<rows;r++){
    const wrap = document.createElement("div");
    wrap.className = "rowWrap";
    wrap.style.width = `${cols * CELL + (cols-1) * GAP}px`;

    const grid = document.createElement("div");
    grid.className = "grid";
    grid.style.gridTemplateColumns = `repeat(${cols}, var(--cell))`;

    const layer = document.createElement("div");
    layer.className = "noteLayer";

    for(let c=0;c<cols;c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.onmousedown = (e) => e.preventDefault();
      cell.onclick = () => onCellClick(r, c);
      grid.appendChild(cell);
    }

    wrap.appendChild(grid);
    wrap.appendChild(layer);
    sequencerEl.appendChild(wrap);

    noteLayerEls.push(layer);
  }

  redrawAllNotes();
}

function canPlace(r, start, len){
  if(start < 0) return false;
  if(start + len > cols) return false;
  for(let c=start; c<start+len; c++){
    if(occ[r][c] !== null) return false;
  }
  return true;
}

function placeNote(r, start, len){
  const id = nextId++;
  notesByRow[r].push({ id, start, len });
  for(let c=start; c<start+len; c++) occ[r][c] = id;
}

function deleteNoteById(r, id){
  const idx = notesByRow[r].findIndex(n => n.id === id);
  if(idx === -1) return;
  const { start, len } = notesByRow[r][idx];
  for(let c=start; c<start+len; c++) occ[r][c] = null;
  notesByRow[r].splice(idx, 1);
}

function overlappingNoteIds(r, start, len){
  const set = new Set();
  for(let c=start; c<start+len; c++){
    const id = occ[r][c];
    if(id !== null) set.add(id);
  }
  return set;
}

function smartPlaceNote(r, clickCol, len){
  let baseStart = Math.min(clickCol, cols - len);
  baseStart = Math.max(0, baseStart);

  for(let start = baseStart; start >= 0; start--){
    if(start + len > cols) continue;
    if(canPlace(r, start, len)){
      placeNote(r, start, len);
      return;
    }
  }

  const overlaps = overlappingNoteIds(r, baseStart, len);
  overlaps.forEach(id => deleteNoteById(r, id));
  placeNote(r, baseStart, len);
}

function onCellClick(r, c){
  const existing = occ[r][c];
  if(existing !== null){
    pushUndo();
    deleteNoteById(r, existing);
    redrawRowNotes(r);
    return;
  }

  pushUndo();
  smartPlaceNote(r, c, selectedSteps);
  redrawRowNotes(r);
}

function redrawAllNotes(){
  for(let r=0;r<rows;r++) redrawRowNotes(r);
}

function redrawRowNotes(r){
  const layer = noteLayerEls[r];
  layer.innerHTML = "";

  for(const note of notesByRow[r]){
    const block = document.createElement("div");
    block.className = "noteBlock";
    block.dataset.id = String(note.id);

    const left = note.start * (CELL + GAP);
    const width = note.len * CELL + (note.len - 1) * GAP;

    block.style.left = `${left}px`;
    block.style.top = `0px`;
    block.style.width = `${width}px`;
    block.style.background = rowColors[r];

    block.onmousedown = (e) => e.preventDefault();

    block.onclick = (e) => {
      e.stopPropagation();
      pushUndo();
      deleteNoteById(r, note.id);
      redrawRowNotes(r);
    };

    layer.appendChild(block);
  }
}

/* -------------------- PLAYHEAD -------------------- */
function setPlayheadVisible(on){ playheadEl.style.display = on ? "block" : "none"; }
function setPlayheadPlaying(isPlaying){ playheadEl.classList.toggle("playing", isPlaying); }
function movePlayheadToStep(s){ playheadEl.style.left = `${s * (CELL + GAP)}px`; }
function resetPlayheadInstant(){
  playheadEl.style.transition = "none";
  movePlayheadToStep(0);
  void playheadEl.offsetWidth;
  playheadEl.style.transition = "left 70ms linear";
}

/* -------------------- ENVELOPE -------------------- */
function scheduleEnvelope(g, now, hold, attack, peak, sustain, release, decay1){
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(peak, now + attack);
  if(decay1 > 0){
    g.gain.exponentialRampToValueAtTime(sustain, now + attack + decay1);
  }else{
    g.gain.setValueAtTime(sustain, now + attack);
  }
  g.gain.setValueAtTime(sustain, now + hold);
  g.gain.exponentialRampToValueAtTime(0.0001, now + hold + release);
}

/* -------------------- INSTRUMENTS -------------------- */
function playPiano(freq, steps){
  const now = audioCtx.currentTime;
  const hold = steps * stepDurationSec();

  const release = Math.min(0.32, Math.max(0.16, hold * 0.12));
  const stopAt = now + hold + release + 0.20;

  const env = audioCtx.createGain();
  scheduleEnvelope(env, now, hold, 0.012, 0.70, 0.62, release, 0.03);

  const level = audioCtx.createGain();
  level.gain.setValueAtTime(LEVEL.piano, now);
  env.connect(level);

  const partials = [
    { mult: 1, amp: 0.34 },
    { mult: 2, amp: 0.24 },
    { mult: 3, amp: 0.18 },
    { mult: 4, amp: 0.13 },
    { mult: 5, amp: 0.09 },
    { mult: 6, amp: 0.06 },
    { mult: 8, amp: 0.04 }
  ];

  const mix = audioCtx.createGain();
  mix.gain.setValueAtTime(1.0, now);

  const oscs = [];
  for(const p of partials){
    const o = audioCtx.createOscillator();
    o.type = "sine";
    o.frequency.setValueAtTime(freq * p.mult, now);

    const g = audioCtx.createGain();
    g.gain.setValueAtTime(p.amp, now);

    o.connect(g);
    g.connect(mix);

    oscs.push(o);
  }

  const chiffBuf = audioCtx.createBuffer(1, Math.floor(audioCtx.sampleRate * 0.04), audioCtx.sampleRate);
  const data = chiffBuf.getChannelData(0);
  for(let i=0;i<data.length;i++){
    const t = i / data.length;
    data[i] = (Math.random()*2-1) * Math.pow(1 - t, 5);
  }
  const chiff = audioCtx.createBufferSource();
  chiff.buffer = chiffBuf;

  const chiffBP = audioCtx.createBiquadFilter();
  chiffBP.type = "bandpass";
  chiffBP.frequency.setValueAtTime(2400, now);
  chiffBP.Q.setValueAtTime(0.9, now);

  const chiffG = audioCtx.createGain();
  chiffG.gain.setValueAtTime(0.0001, now);
  chiffG.gain.exponentialRampToValueAtTime(0.10, now + 0.005);
  chiffG.gain.exponentialRampToValueAtTime(0.0001, now + 0.04);

  chiff.connect(chiffBP);
  chiffBP.connect(chiffG);
  chiffG.connect(env);

  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.setValueAtTime(80, now);
  hp.Q.setValueAtTime(0.7, now);

  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.setValueAtTime(4200, now);
  lp.Q.setValueAtTime(0.6, now);

  mix.connect(hp);
  hp.connect(lp);
  lp.connect(env);

  level.connect(bus.piano.input);

  for(const o of oscs) trackNode(o);
  trackNode(chiff);

  for(const o of oscs) o.start(now);
  chiff.start(now);

  for(const o of oscs) o.stop(stopAt);
  chiff.stop(now + 0.05);
}

function playTrumpet(freq, steps){
  const now = audioCtx.currentTime;
  const hold = steps * stepDurationSec();
  const release = Math.min(0.16, Math.max(0.09, hold * 0.08));
  const stopAt = now + hold + release + 0.10;

  const env = audioCtx.createGain();
  scheduleEnvelope(env, now, hold, 0.016, 0.36, 0.24, release, 0.07);

  const level = audioCtx.createGain();
  level.gain.setValueAtTime(LEVEL.trumpet, now);
  env.connect(level);

  const o1 = audioCtx.createOscillator();
  const o2 = audioCtx.createOscillator();
  o1.type = "sawtooth";
  o2.type = "sawtooth";
  o1.frequency.setValueAtTime(freq, now);
  o2.frequency.setValueAtTime(freq, now);
  o2.detune.setValueAtTime(+8, now);

  const bp = audioCtx.createBiquadFilter();
  bp.type = "bandpass";
  bp.frequency.setValueAtTime(freq * 2.5, now);
  bp.Q.setValueAtTime(0.95, now);

  const lfo = audioCtx.createOscillator();
  lfo.type = "sine";
  lfo.frequency.setValueAtTime(5.4, now);
  const lfoG = audioCtx.createGain();
  lfoG.gain.setValueAtTime(9, now);
  lfo.connect(lfoG);
  lfoG.connect(o1.detune);
  lfoG.connect(o2.detune);

  const g1 = audioCtx.createGain();
  const g2 = audioCtx.createGain();
  g1.gain.setValueAtTime(0.60, now);
  g2.gain.setValueAtTime(0.55, now);

  o1.connect(g1); o2.connect(g2);
  g1.connect(bp); g2.connect(bp);
  bp.connect(env);

  level.connect(bus.trumpet.input);

  trackNode(o1); trackNode(o2); trackNode(lfo);

  o1.start(now); o2.start(now); lfo.start(now);
  o1.stop(stopAt); o2.stop(stopAt); lfo.stop(stopAt);
}

function playStrings(freq, steps){
  const now = audioCtx.currentTime;
  const hold = steps * stepDurationSec();

  const padHold = Math.max(hold, 0.22);
  const release = Math.min(0.55, Math.max(0.22, padHold * 0.35));
  const stopAt = now + padHold + release + 0.18;

  const env = audioCtx.createGain();
  scheduleEnvelope(env, now, padHold, 0.045, 0.38, 0.26, release, 0.18);

  const level = audioCtx.createGain();
  level.gain.setValueAtTime(LEVEL.strings, now);
  env.connect(level);

  const s1 = audioCtx.createOscillator();
  const s2 = audioCtx.createOscillator();
  const s3 = audioCtx.createOscillator();
  const sub = audioCtx.createOscillator();

  s1.type = "sawtooth";
  s2.type = "sawtooth";
  s3.type = "sawtooth";
  sub.type = "triangle";

  s1.frequency.setValueAtTime(freq, now);
  s2.frequency.setValueAtTime(freq, now);
  s3.frequency.setValueAtTime(freq, now);
  sub.frequency.setValueAtTime(freq * 0.5, now);

  s2.detune.setValueAtTime(+9, now);
  s3.detune.setValueAtTime(-11, now);

  const lfo = audioCtx.createOscillator();
  lfo.type = "sine";
  lfo.frequency.setValueAtTime(0.35, now);
  const lfoG = audioCtx.createGain();
  lfoG.gain.setValueAtTime(10, now);
  lfo.connect(lfoG);
  lfoG.connect(s1.detune);
  lfoG.connect(s2.detune);
  lfoG.connect(s3.detune);

  const mix = audioCtx.createGain();
  const g1 = audioCtx.createGain();
  const g2 = audioCtx.createGain();
  const g3 = audioCtx.createGain();
  const gs = audioCtx.createGain();
  g1.gain.setValueAtTime(0.30, now);
  g2.gain.setValueAtTime(0.28, now);
  g3.gain.setValueAtTime(0.28, now);
  gs.gain.setValueAtTime(0.20, now);

  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.setValueAtTime(1900, now);
  lp.frequency.exponentialRampToValueAtTime(980, now + 0.40);
  lp.Q.setValueAtTime(0.85, now);

  const shelf = audioCtx.createBiquadFilter();
  shelf.type = "highshelf";
  shelf.frequency.setValueAtTime(3400, now);
  shelf.gain.setValueAtTime(2.0, now);

  s1.connect(g1); s2.connect(g2); s3.connect(g3); sub.connect(gs);
  g1.connect(mix); g2.connect(mix); g3.connect(mix); gs.connect(mix);

  mix.connect(lp);
  lp.connect(shelf);
  shelf.connect(env);

  level.connect(bus.strings.input);

  trackNode(s1); trackNode(s2); trackNode(s3); trackNode(sub); trackNode(lfo);

  s1.start(now); s2.start(now); s3.start(now); sub.start(now); lfo.start(now);
  s1.stop(stopAt); s2.stop(stopAt); s3.stop(stopAt); sub.stop(stopAt); lfo.stop(stopAt);
}

function playSynth(freq, steps){
  const now = audioCtx.currentTime;
  const hold = steps * stepDurationSec();
  const release = Math.min(0.18, Math.max(0.10, hold * 0.08));
  const stopAt = now + hold + release + 0.12;

  const env = audioCtx.createGain();
  scheduleEnvelope(env, now, hold, 0.0025, 0.62, 0.22, release, 0.055);

  const level = audioCtx.createGain();
  level.gain.setValueAtTime(LEVEL.synth, now);
  env.connect(level);

  const osc = audioCtx.createOscillator();
  osc.type = "square";
  osc.frequency.setValueAtTime(freq, now);

  const lp = audioCtx.createBiquadFilter();
  lp.type = "lowpass";
  lp.frequency.setValueAtTime(2600, now);
  lp.frequency.exponentialRampToValueAtTime(1800, now + 0.10);
  lp.Q.setValueAtTime(0.9, now);

  osc.connect(lp);
  lp.connect(env);
  level.connect(bus.synth.input);

  trackNode(osc);
  osc.start(now);
  osc.stop(stopAt);
}

function playInstrument(freq, steps){
  lastAudioActivityAt = performance.now();

  if(instrument === "piano")   return playPiano(freq, steps);
  if(instrument === "trumpet") return playTrumpet(freq, steps);
  if(instrument === "strings") return playStrings(freq, steps);
  return playSynth(freq, steps);
}

/* -------------------- PLAYBACK -------------------- */
async function play(){
  await ensureAudioReady();

  stop();

  step = 0;
  setPlayheadVisible(true);
  setPlayheadPlaying(false);
  resetPlayheadInstant();

  const nowMs = performance.now();
  const idleMs = (lastStopAt === null) ? Infinity : (nowMs - lastStopAt);
  const audioIdleMs = (lastAudioActivityAt == null) ? Infinity : (nowMs - lastAudioActivityAt);

  let delayMs = 80;
  if(!hasEverStartedPlayback) delayMs = 500;
  else if(Math.max(idleMs, audioIdleMs) > 25000) delayMs = 750;
  else if(Math.max(idleMs, audioIdleMs) > 5000) delayMs = 500;

  startTimeout = setTimeout(() => {
    startTimeout = null;
    startSequencer();
    hasEverStartedPlayback = true;
  }, delayMs);
}



function setBlockPulseVars(el){
  // Make the "swell" feel like a consistent number of pixels for every block,
  // instead of a constant scale factor (which exaggerates long blocks).
  try{
    const r = el.getBoundingClientRect();
    const w = Math.max(1, r.width);
    const h = Math.max(1, r.height);
    const delta = 4; // px added per side
    let sx = (w + delta*2) / w;
    let sy = (h + delta*2) / h;
    // Clamp so tiny blocks don't blow up
    sx = Math.min(1.12, Math.max(1.0, sx));
    sy = Math.min(1.18, Math.max(1.0, sy));
    const sx2 = 1 + (sx - 1) * 0.35;
    const sy2 = 1 + (sy - 1) * 0.35;
    el.style.setProperty('--sx', sx.toFixed(4));
    el.style.setProperty('--sy', sy.toFixed(4));
    el.style.setProperty('--sx2', sx2.toFixed(4));
    el.style.setProperty('--sy2', sy2.toFixed(4));
  }catch(e){
    // ignore
  }
}

function startSequencer(){
  let firstTick = true;

  function tick(){
    movePlayheadToStep(step);

    if(firstTick){
      setPlayheadPlaying(true);
      firstTick = false;
    }

    for(let r=0;r<rows;r++){
      const note = notesByRow[r].find(n => n.start === step);
      if(note){
        playInstrument(freqs[r], note.len);

        const block = noteLayerEls[r].querySelector(`.noteBlock[data-id="${note.id}"]`);
        if(block){
          setBlockPulseVars(block);
          block.classList.remove("playing");
          void block.offsetWidth;
          block.classList.add("playing");
        }
      }
    }

    // Drums (runs in time with the sequencer)
    playDrumsAtStep(step);

    step = (step + 1) % cols;

    if(step === 0 && pendingTempo !== null){
      tempo = pendingTempo;
      pendingTempo = null;
      updateTempoBox();
      setPlayheadWobbleFromTempo(tempo);
      restartInterval(stepDurationSec() * 1000);
    }
  }

  function restartInterval(intervalMs){
    if(timer){
      clearInterval(timer);
      timer = null;
    }
    timer = setInterval(tick, intervalMs);
  }

  tick();
  restartInterval(stepDurationSec() * 1000);
}

function stop(){
  if(timer){
    clearInterval(timer);
    timer = null;
  }
  if(startTimeout){
    clearTimeout(startTimeout);
    startTimeout = null;
  }
  setPlayheadPlaying(false);
  setPlayheadVisible(false);
  stopAllAudioNow();
  lastStopAt = performance.now();
}

/* -------------------- TEMPO -------------------- */
function updateTempoBox(){
  tempoBox.textContent = (pendingTempo !== null) ? pendingTempo : tempo;
}
function requestTempo(newTempo){
  newTempo = Math.max(40, Math.min(200, newTempo));
  if(timer){
    pendingTempo = newTempo;
    updateTempoBox();
    setPlayheadWobbleFromTempo(pendingTempo);
    return;
  }
  tempo = newTempo;
  pendingTempo = null;
  updateTempoBox();
  setPlayheadWobbleFromTempo(tempo);
}
function tempoUp(){
  if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; }
const base = (pendingTempo !== null) ? pendingTempo : tempo;
  requestTempo(base + 5);
}
function tempoDown(){
  if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; }
const base = (pendingTempo !== null) ? pendingTempo : tempo;
  requestTempo(base - 5);
}

/* -------------------- CLEAR -------------------- */
function clearGrid(){
  pushUndo();
  notesByRow = Array.from({length: rows}, () => []);
  occ = Array.from({length: rows}, () => Array(cols).fill(null));
  redrawAllNotes();
}



/* -------------------- CAMERA SCAN (simple heuristic) -------------------- */
let camStream = null;
let camCapturedDataUrl = null;

const camModalEl = document.getElementById("camModal");
const camVideoEl = document.getElementById("camVideo");
const camCanvasEl = document.getElementById("camCanvas");
const camPreviewEl = document.getElementById("camPreview");

async function openCameraModal(){
  if(!isLoggedIn){ showLockNudge(); hideLockNudgeSoon(900); return; }
  try{
    if(!camModalEl || !camVideoEl || !camCanvasEl || !camPreviewEl){
      alert("Camera UI is missing in the HTML (camModal/camVideo/camCanvas/camPreview).\nIf you edited the file, make sure that block still exists.");
      return;
    }

    if(!window.isSecureContext){
      alert("Camera access needs a secure context.\nOpen this page via https:// or http://localhost (not file://).\n\nCurrent URL:\n" + location.href);
      return;
    }

    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      alert("Camera API not available in this browser.");
      return;
    }

    camCapturedDataUrl = null;
    camPreviewEl.style.display = "none";
    camVideoEl.style.display = "block";

    camModalEl.classList.add("show");
    camModalEl.setAttribute("aria-hidden", "false");

    const primaryConstraints = { video: { facingMode: { ideal: "environment" } }, audio: false };
    const fallbackConstraints = { video: true, audio: false };

    try{
      camStream = await navigator.mediaDevices.getUserMedia(primaryConstraints);
    }catch(err){
      // Some devices/browsers don't like facingMode constraints.
      if(err && (err.name === "OverconstrainedError" || err.name === "NotFoundError")){
        camStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
      }else{
        throw err;
      }
    }

    camVideoEl.srcObject = camStream;
    await camVideoEl.play().catch(()=>{});
  }catch(e){
    console.error("Camera open failed:", e);
    const name = (e && e.name) ? e.name : "Error";
    const msg  = (e && e.message) ? e.message : "";

    if(name === "NotAllowedError" || name === "SecurityError"){
      alert("Camera permission was blocked.\n\nFix:\n1) Click the padlock icon in the address bar\n2) Site settings -> Camera -> Allow\n3) Reload the page\n\n(" + name + (msg ? ": " + msg : "") + ")");
      return;
    }

    if(name === "NotReadableError"){
      alert("The camera may be in use by another app/tab (Zoom/Meet/etc).\nClose other apps using the camera, then try again.\n\n(" + name + (msg ? ": " + msg : "") + ")");
      return;
    }

    alert("Could not open the camera.\n\n(" + name + (msg ? ": " + msg : "") + ")");
  }
}

function closeCameraModal(){
  camModalEl.classList.remove("show");
  camModalEl.setAttribute("aria-hidden", "true");
  try{
    if(camStream){
      camStream.getTracks().forEach(t => { try{ t.stop(); }catch(e){} });
    }
  }catch(e){}
  camStream = null;
}

function camCapture(){
  if(!camVideoEl || !camVideoEl.videoWidth) return;
  const w = camVideoEl.videoWidth;
  const h = camVideoEl.videoHeight;
  camCanvasEl.width = w;
  camCanvasEl.height = h;
  const ctx = camCanvasEl.getContext("2d");
  ctx.drawImage(camVideoEl, 0, 0, w, h);
  camCapturedDataUrl = camCanvasEl.toDataURL("image/png");
  camPreviewEl.src = camCapturedDataUrl;
  camPreviewEl.style.display = "block";
  camVideoEl.style.display = "none";
}

function camImport(){
  if(!camCapturedDataUrl){
    camCapture();
    if(!camCapturedDataUrl) return;
  }
  importGridFromDataUrl(camCapturedDataUrl);
  closeCameraModal();
}

function importGridFromDataUrl(dataUrl){
  const img = new Image();
  img.onload = () => {
    const w = img.naturalWidth;
    const h = img.naturalHeight;
    camCanvasEl.width = w;
    camCanvasEl.height = h;
    const ctx = camCanvasEl.getContext("2d");
    ctx.drawImage(img, 0, 0, w, h);

    const { data } = ctx.getImageData(0, 0, w, h);

    // centered crop to reduce background impact
    const cropX = Math.floor(w * 0.10);
    const cropY = Math.floor(h * 0.12);
    const cropW = Math.floor(w * 0.80);
    const cropH = Math.floor(h * 0.76);

    function idx(px, py){ return (py * w + px) * 4; }

    function sampleCell(r, c){
      // sample a few points inside the cell
      const x0 = cropX + Math.floor((c + 0.15) * cropW / cols);
      const x1 = cropX + Math.floor((c + 0.85) * cropW / cols);
      const y0 = cropY + Math.floor((r + 0.20) * cropH / rows);
      const y1 = cropY + Math.floor((r + 0.80) * cropH / rows);

      const pts = [
        [x0, y0],
        [x1, y0],
        [Math.floor((x0+x1)/2), Math.floor((y0+y1)/2)],
        [x0, y1],
        [x1, y1]
      ];

      let satSum = 0;
      let lumSum = 0;
      for(const [x,y] of pts){
        const i = idx(Math.max(0, Math.min(w-1, x)), Math.max(0, Math.min(h-1, y)));
        const R = data[i]/255, G = data[i+1]/255, B = data[i+2]/255;
        const maxv = Math.max(R,G,B);
        const minv = Math.min(R,G,B);
        const lum = (maxv + minv) * 0.5;
        const sat = (maxv === 0) ? 0 : (maxv - minv) / maxv; // simple saturation proxy
        satSum += sat;
        lumSum += lum;
      }
      const sat = satSum / pts.length;
      const lum = lumSum / pts.length;

      // heuristic: colored if reasonably saturated and not near-white
      return (sat > 0.18) && (lum < 0.92);
    }

    pushUndo();
    notesByRow = Array.from({length: rows}, () => []);
    occ = Array.from({length: rows}, () => Array(cols).fill(null));
    nextId = 1;

    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        if(sampleCell(r,c)){
          if(canPlace(r, c, 1)) placeNote(r, c, 1);
        }
      }
    }

    redrawAllNotes();
  };
  img.src = dataUrl;
}


/* -------------------- INIT -------------------- */
function init(){
  setupMobileTabs();
  fitToViewport();
  buildGrid();
  positionRobotLogo();
  setInstrument("piano");
  updateTempoBox();
  setPlayheadWobbleFromTempo(tempo);

  requestAnimationFrame(() => { fitToViewport(); positionRobotLogo(); });
}
init();


/* -------------------- OPTION A EXPORTS --------------------
   Keep inline onclick handlers working (play/stop/tempo/etc) while still providing
   a structured, manager-friendly namespace at window.KidSequencer.
   This is intentionally additive: UI + behaviour remain exactly the same.
*/

// Inline-handler globals (used by existing HTML attributes)
window.play = play;
window.stop = stop;
window.clearGrid = clearGrid;
window.undo = undo;
window.openCameraModal = openCameraModal;
window.closeCameraModal = closeCameraModal;
window.camCapture = camCapture;
window.camImport = camImport;
window.tempoUp = tempoUp;
window.tempoDown = tempoDown;
window.logout = logout;

// Organised namespace for maintenance/debugging (optional)
window.KidSequencer = {
  State: {
    get tempo(){ return tempo; },
    set tempo(v){ tempo = v; updateTempoBox(); setPlayheadWobbleFromTempo(tempo); },
    get instrument(){ return instrument; },
    set instrument(v){ setInstrument(v); },
    get isLoggedIn(){ return isLoggedIn; }
  },
  UI: {
    fitToViewport,
    positionRobotLogo,
    updateTempoBox,
    updateLoginLinks,
    applyLockState,
    showLockNudge,
    hideLockNudgeSoon,
    setPlayheadWobbleFromTempo
  },
  Audio: {
    ensureAudioRunning,
    stopAllAudioNow,
    primeAudioOnce,
    setInstrument,
    playInstrument
  },
  Sequencer: {
    play,
    stop,
    clearGrid,
    undo,
    buildGrid,
    buildTools,
    redrawAllNotes
  },
  Camera: {
    openCameraModal,
    closeCameraModal,
    camCapture,
    camImport
  },
  Auth: { logout }
};

})();
/* OPTION A ORGANISATION END */
</script>
<script type="module">
  import { auth } from "./js/firebase-init.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

  onAuthStateChanged(auth, (user) => {
    // For now, just log it. Next step we'll use this to grey/ungrey buttons.
    console.log("Auth user:", user ? user.email : "none");
  });
</script>




<script>
(function(){
  function initSeqVolumeFader(){
    const area = document.getElementById('seqTrackArea');
    const range = document.getElementById('seqVolRange');
    const knob = document.getElementById('seqKnob');
    const num  = document.getElementById('seqVolNum');
    if(!area || !range || !knob || !num) return;

    // --- Audio master volume hookup ---
    function ensureAudio(){
      // Your app lazily creates the AudioContext in getAudio()
      if(typeof window.getAudio === 'function'){
        const a = window.getAudio();
        // Some browsers start suspended until user gesture
        try{ if(a && a.state === 'suspended') a.resume(); }catch(_){}
      }else{
        // fallback: try the local getAudio if in same scope
        try{ if(typeof getAudio === 'function') { const a = getAudio(); if(a && a.state === 'suspended') a.resume(); } }catch(_){}
      }
    }

    function setMasterGainSmooth(g, snap){
      // g: 0..1
      // snap: boolean -> slightly faster settle
      const target = Math.max(0, Math.min(1, g));
      try{
        // masterGain exists after getAudio()
        const mg = (typeof window.masterGain !== 'undefined' ? window.masterGain : (typeof masterGain !== 'undefined' ? masterGain : null));
        const ac = (typeof window.audioCtx !== 'undefined' ? window.audioCtx : (typeof audioCtx !== 'undefined' ? audioCtx : null));
        if(mg && mg.gain && (ac && ac.currentTime != null)){
          const t = ac.currentTime;
          mg.gain.cancelScheduledValues(t);
          // small glide so it feels smooth
          const glide = snap ? 0.05 : 0.03;
          mg.gain.setValueAtTime(mg.gain.value, t);
          mg.gain.linearRampToValueAtTime(target, t + glide);
        }
      }catch(_){}
    }

    // Startup at 10
    range.value = 10;
    num.textContent = '10';
    knob.setAttribute('aria-valuenow','10');

    // Set audio volume at startup once audio exists
    // (won't create audio until user interacts, but keeps state)
    setMasterGainSmooth(1, true);

    let capSize = 9;
    let knobH = 16;
    let topLimit = 0;
    let bottomLimit = 0;

    function recalcGeometry(){
      const areaRect = area.getBoundingClientRect();
      const cap = area.querySelector('.seqCap');
      capSize = cap ? cap.getBoundingClientRect().height : 9;
      knobH = knob.getBoundingClientRect().height || 16;

      topLimit = capSize;
      bottomLimit = areaRect.height - capSize;

      if(bottomLimit < topLimit + knobH) bottomLimit = topLimit + knobH;
    }

    function valueToCenterY(v){
      const travel = (bottomLimit - topLimit) - knobH;
      const t = (10 - v) / 10;
      return topLimit + (travel * t) + (knobH/2);
    }

    function centerYToValue(centerY){
      const travel = (bottomLimit - topLimit) - knobH;
      const yTop = centerY - knobH/2;
      const t = (yTop - topLimit) / (travel || 1);
      const v = 10 - (t * 10);
      return Math.max(0, Math.min(10, v));
    }

    function setKnobCenterY(centerY){
      knob.style.top = centerY + 'px';
    }

    function updateDisplayFromValue(v){
      const vi = Math.round(v);
      num.textContent = String(vi);
      knob.setAttribute('aria-valuenow', String(vi));
    }

    function applyValue(v, snap){
      const vSnap = snap ? Math.round(v) : v; // fader snaps only on release
      range.value = String(vSnap);
      updateDisplayFromValue(v);
      setKnobCenterY(valueToCenterY(vSnap));

      // Smooth master gain follows the (continuous) fader while dragging,
      // but snaps to the same increment on release.
      const vn = (snap ? Math.round(v) : v) / 10; // 0..1
      // DJ-style fader taper: feels more natural near the bottom (log-ish curve)
      // 0 -> hard mute, 1 -> unity gain
      const gain = (vn <= 0) ? 0 : Math.pow(10, ((vn * 0) + (-60 * (1 - vn))) / 20);
      setMasterGainSmooth(gain, snap);
    }

    function layoutFromRange(){
      recalcGeometry();
      const v = Number(range.value);
      updateDisplayFromValue(v);
      setKnobCenterY(valueToCenterY(v));
    }

    let dragging = false;

    function pointerToCenterY(e){
      const areaRect = area.getBoundingClientRect();
      const y = e.clientY - areaRect.top;

      const minCenter = topLimit + (knobH/2);
      const maxCenter = (bottomLimit - knobH) + (knobH/2);

      return Math.max(minCenter, Math.min(maxCenter, y));
    }

    function onPointerDown(e){
      ensureAudio();
      recalcGeometry();
      dragging = true;
      try{ area.setPointerCapture(e.pointerId); }catch(_){}

      const centerY = pointerToCenterY(e);
      const v = centerYToValue(centerY);
      applyValue(v, false);
      e.preventDefault();
    }

    function onPointerMove(e){
      if(!dragging) return;
      const centerY = pointerToCenterY(e);
      const v = centerYToValue(centerY);
      applyValue(v, false);
      e.preventDefault();
    }

    function onPointerUp(e){
      if(!dragging) return;
      dragging = false;

      const centerY = pointerToCenterY(e);
      const v = centerYToValue(centerY);
      applyValue(v, true);

      try{ area.releasePointerCapture(e.pointerId); }catch(_){}
      e.preventDefault();
    }

    area.addEventListener('pointerdown', onPointerDown);
    area.addEventListener('pointermove', onPointerMove);
    area.addEventListener('pointerup', onPointerUp);
    area.addEventListener('pointercancel', onPointerUp);

    window.addEventListener('resize', layoutFromRange);

    requestAnimationFrame(layoutFromRange);
    setTimeout(layoutFromRange, 50);
  }

  document.addEventListener('DOMContentLoaded', initSeqVolumeFader);
})();
</script>





<script>
(function(){
  // Mobile landscape condition: touch phone in landscape with limited height.
  var mq = window.matchMedia('(hover: none) and (pointer: coarse) and (orientation: landscape) and (max-width: 980px) and (max-height: 520px)');
  var moved = new Map();
  var inMobile = false;

  function remember(el){
    if(!el || moved.has(el)) return;
    moved.set(el, { parent: el.parentNode, next: el.nextSibling });
  }
  function move(el, newParent){
    if(!el || !newParent) return;
    remember(el);
    newParent.appendChild(el);
  }
  function restore(el){
    if(!el) return;
    var info = moved.get(el);
    if(!info || !info.parent) return;
    if(info.next && info.next.parentNode === info.parent){
      info.parent.insertBefore(el, info.next);
    }else{
      info.parent.appendChild(el);
    }
  }

  function openDrawer(side){
    var overlay = document.getElementById('drawerOverlay');
    var left = document.getElementById('leftDrawer');
    var right = document.getElementById('rightDrawer');
    if(!overlay || !left || !right) return;

    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden','false');

    if(side === 'left'){
      left.classList.add('open','left');
      left.setAttribute('aria-hidden','false');
    }else{
      right.classList.add('open','right');
      right.setAttribute('aria-hidden','false');
    }
  }
  function closeDrawers(){
    var overlay = document.getElementById('drawerOverlay');
    var left = document.getElementById('leftDrawer');
    var right = document.getElementById('rightDrawer');
    if(overlay){
      overlay.classList.remove('open');
      overlay.setAttribute('aria-hidden','true');
    }
    if(left){
      left.classList.remove('open','left');
      left.setAttribute('aria-hidden','true');
    }
    if(right){
      right.classList.remove('open','right');
      right.setAttribute('aria-hidden','true');
    }
  }

  function ensureTopAuthButton(group){
    var btn = document.getElementById('topAuthBtn');
    if(!btn){
      btn = document.createElement('button');
      btn.id = 'topAuthBtn';
      btn.type = 'button';
      btn.className = 'topAuthBtn';
      group.appendChild(btn);
    }
    return btn;
  }

  function syncTopAuth(){
    var group = document.getElementById('mobileAuthGroup');
    if(!group) return;

    var logged = false;
    try{ logged = localStorage.getItem('kidseq_logged_in') === '1'; }catch(e){ logged = false; }

    var btn = ensureTopAuthButton(group);
    if(logged){
      btn.textContent = 'Logout';
      btn.onclick = function(){ if(typeof window.logout === 'function') window.logout(); };
    }else{
      btn.textContent = 'Login';
      btn.onclick = function(){ window.location.href = 'login.html'; };
    }
  }

  function layoutAuthGroup(){
    if(!inMobile) return;

    var wrap = document.getElementById('contentWrap');
    var group = document.getElementById('mobileAuthGroup');
    var pill = document.getElementById('memberPill');
    var camera = document.getElementById('cameraBtn');
    var gridShell = document.getElementById('sequencerShell');
    if(!wrap || !group || !pill || !camera || !gridShell) return;

    // Ensure pill lives in the mobile group (pill first, then login/logout)
    if(pill.parentNode !== group){
      move(pill, group);
    }
    syncTopAuth();

    var wrapRect = wrap.getBoundingClientRect();
    var camRect  = camera.getBoundingClientRect();
    var gridRect = gridShell.getBoundingClientRect();

    group.style.display = 'flex';

    var groupRect = group.getBoundingClientRect();
    var groupW = groupRect.width;

    // Right edge aligns with grid shell's right edge
    var desiredLeft = (gridRect.right - wrapRect.left) - groupW;

    // Keep it to the right of the camera button with a small gap
    var minLeft = (camRect.right - wrapRect.left) + 8;
    if(desiredLeft < minLeft) desiredLeft = minLeft;

    // Vertically center with camera button
    var top = (camRect.top - wrapRect.top) + (camRect.height - groupRect.height)/2;

    group.style.left = Math.max(0, desiredLeft) + 'px';
    group.style.top  = Math.max(0, top) + 'px';
  }

  function sizeGridToAvailable(){
    if(!inMobile) return;

    var root = document.documentElement;
    var main = document.getElementById('mainLayout');
    var rightCol = document.getElementById('rightCol');
    if(!main || !rightCol) return;

    var cs = getComputedStyle(root);
    var gap = parseFloat(cs.getPropertyValue('--gap')) || 4;

    var mainRect = main.getBoundingClientRect();
    var rightRect = rightCol.getBoundingClientRect();

    // Available width for the 16-step grid area (inside the sequencer shell)
    // mainRect includes padding; we just approximate by taking viewport width minus right column minus a safety margin.
    var safety = 26; // breathing room for borders/padding/gap
    var avail = Math.max(240, window.innerWidth - rightRect.width - safety);

    var cell = Math.floor((avail - (gap * 15)) / 16);

    // Clamp so it stays usable and doesn't blow up.
    cell = Math.max(28, Math.min(60, cell));

    root.style.setProperty('--cell', cell + 'px');
  }

  function layoutTitleBoxToGrid(){
    if(!inMobile) return;

    var topBar = document.getElementById('topBar');
    var title = document.getElementById('titleBox');
    var gridShell = document.getElementById('sequencerShell');
    var sequencer = document.getElementById('sequencer');
    if(!topBar || !title || !gridShell || !sequencer) return;

    var barRect = topBar.getBoundingClientRect();
    var shellRect = gridShell.getBoundingClientRect();

    // Find the right edge of the 5th grid cell in the first row (if it exists)
    var firstRow = sequencer.querySelector('.rowWrap');
    var cell5 = firstRow && firstRow.querySelector('.grid .cell:nth-child(5)');
    var targetRight = cell5 ? cell5.getBoundingClientRect().right : (shellRect.left + (shellRect.width * 0.35));

    var leftPx = (shellRect.left - barRect.left);
    var widthPx = Math.max(80, (targetRight - shellRect.left));

    title.style.left = leftPx + 'px';
    title.style.width = widthPx + 'px';
  }

  function layoutRightColToGrid(){
    if(!inMobile) return;

    var rightCol = document.getElementById('rightCol');
    var gridShell = document.getElementById('sequencerShell');
    var grid = document.getElementById('sequencer');
    if(!rightCol || !gridShell || !grid) return;

    var shellRect = gridShell.getBoundingClientRect();
    var gridRect  = grid.getBoundingClientRect();

    // Make the right column match the shell height so we can bottom-align the beat buttons.
    rightCol.style.height = shellRect.height + 'px';

    // Pad so the sound buttons start level with the grid top, and the beat buttons can end level with the grid bottom.
    var padTop = Math.max(0, gridRect.top - shellRect.top);
    var padBot = Math.max(0, shellRect.bottom - gridRect.bottom);

    rightCol.style.paddingTop = padTop + 'px';
    rightCol.style.paddingBottom = padBot + 'px';
  }

  function relayout(){
    if(!inMobile) return;

    // 1) size grid based on available width
    sizeGridToAvailable();

    // 2) after the browser reflows, align the title, auth, and right column to the grid
    requestAnimationFrame(function(){
      layoutTitleBoxToGrid();
      layoutAuthGroup();
      layoutRightColToGrid();
    });
  }

  function enterMobile(){
    if(inMobile) return;
    inMobile = true;

    var overlay = document.getElementById('drawerOverlay');
    var leftHandle = document.getElementById('leftDrawerHandle');
    var rightHandle = document.getElementById('rightDrawerHandle');
    var leftDrawer = document.getElementById('leftDrawer');
    var rightDrawer = document.getElementById('rightDrawer');

    var leftContent = document.getElementById('leftDrawerContent');
    var rightContent = document.getElementById('rightDrawerContent');

    var toolsList = document.getElementById('toolsList');          // Note lengths live here
    var tempo = document.getElementById('tempoControls');          // Tempo control box
    var volUI = document.getElementById('masterVolUI');            // Master volume fader UI

    var robot = document.getElementById('robotLogo');
    var rightCol = document.getElementById('rightCol');
    var instButtons = document.getElementById('instButtons');
    var drumPanel = document.getElementById('drumPanel');

    // Move note length buttons into left drawer
    if(toolsList && leftContent) move(toolsList, leftContent);

    // Move tempo + volume into right drawer (side-by-side row)
    var rightRow = document.getElementById('rightDrawerRow');
    if(!rightRow && rightContent){
      rightRow = document.createElement('div');
      rightRow.id = 'rightDrawerRow';
      rightContent.appendChild(rightRow);
    }
    if(tempo && rightRow) move(tempo, rightRow);
    if(volUI && rightRow) move(volUI, rightRow);

    // Robot: under sound buttons
    if(robot && rightCol){
      remember(robot);
      if(instButtons && instButtons.parentNode === rightCol){
        rightCol.insertBefore(robot, instButtons.nextSibling);
      }else{
        rightCol.appendChild(robot);
      }
    }

    // Beat selector: into right column under robot, bottom-aligned with the grid
    if(drumPanel && rightCol){
      remember(drumPanel);
      rightCol.appendChild(drumPanel);
    }

    // Show mobile-only UI
    if(leftHandle) leftHandle.style.display = 'flex';
    if(rightHandle) rightHandle.style.display = 'flex';
    if(leftDrawer) leftDrawer.style.display = 'flex';
    if(rightDrawer) rightDrawer.style.display = 'flex';
    if(overlay) overlay.style.display = '';

    // Wire up interactions
    if(leftHandle) leftHandle.onclick = function(){ openDrawer('left'); };
    if(rightHandle) rightHandle.onclick = function(){ openDrawer('right'); };
    if(overlay) overlay.onclick = closeDrawers;

    var closes = document.querySelectorAll('.drawerClose');
    closes.forEach(function(btn){ btn.onclick = closeDrawers; });

    // Layout & keep synced
    syncTopAuth();
    relayout();

    window.addEventListener('resize', relayout);
    window.addEventListener('orientationchange', relayout);
    window.addEventListener('scroll', relayout, { passive: true });

    // Give the grid time to build (if it is created after DOMContentLoaded)
    setTimeout(relayout, 60);
    setTimeout(relayout, 200);
  }

  function exitMobile(){
    if(!inMobile) return;
    inMobile = false;

    closeDrawers();

    // Restore moved nodes
    restore(document.getElementById('toolsList'));
    restore(document.getElementById('tempoControls'));
    restore(document.getElementById('masterVolUI'));
    restore(document.getElementById('memberPill'));
    restore(document.getElementById('robotLogo'));
    restore(document.getElementById('drumPanel'));

    // Clear inline styles added for mobile
    var title = document.getElementById('titleBox');
    if(title){ title.style.left=''; title.style.width=''; }

    var rightCol = document.getElementById('rightCol');
    if(rightCol){
      rightCol.style.height = '';
      rightCol.style.paddingTop = '';
      rightCol.style.paddingBottom = '';
    }

    // Hide mobile-only UI (falls back to default CSS)
    var leftHandle = document.getElementById('leftDrawerHandle');
    var rightHandle = document.getElementById('rightDrawerHandle');
    var leftDrawer = document.getElementById('leftDrawer');
    var rightDrawer = document.getElementById('rightDrawer');
    var overlay = document.getElementById('drawerOverlay');
    var group = document.getElementById('mobileAuthGroup');

    if(leftHandle) leftHandle.style.display = 'none';
    if(rightHandle) rightHandle.style.display = 'none';
    if(leftDrawer) leftDrawer.style.display = 'none';
    if(rightDrawer) rightDrawer.style.display = 'none';
    if(overlay) overlay.style.display = 'none';
    if(group){
      group.style.display = 'none';
      group.style.left = '';
      group.style.top = '';
    }

    // Clear dynamic sizing
    document.documentElement.style.removeProperty('--cell');

    window.removeEventListener('resize', relayout);
    window.removeEventListener('orientationchange', relayout);
    window.removeEventListener('scroll', relayout, { passive: true });
  }

  function onChange(){
    if(mq.matches) enterMobile();
    else exitMobile();
  }

  document.addEventListener('DOMContentLoaded', function(){
    onChange();

    // keep auth state synced
    window.addEventListener('storage', function(e){
      if(e && e.key === 'kidseq_logged_in'){
        syncTopAuth();
        relayout();
      }
    });

    // If applyLockState is present, hook it so auth updates whenever state changes
    try{
      if(typeof window.applyLockState === 'function'){
        var _als = window.applyLockState;
        window.applyLockState = function(){
          _als.apply(this, arguments);
          syncTopAuth();
          relayout();
        };
      }
    }catch(_){}
  });

  if(mq.addEventListener) mq.addEventListener('change', onChange);
  else mq.addListener(onChange);
})();
</script>


<script>
(function(){
  function syncMemberPill(){
    var pill = document.getElementById("memberPill");
    if(!pill) return;
    var logged = false;
    try{ logged = localStorage.getItem("kidseq_logged_in") === "1"; }catch(e){ logged = false; }
    pill.textContent = logged ? "Member" : "Guest";
  }
  document.addEventListener("DOMContentLoaded", syncMemberPill);
  window.addEventListener("storage", function(e){
    if(e && e.key === "kidseq_logged_in") syncMemberPill();
  });
  // Also hook into applyLockState if it exists
  try{
    if(typeof window.applyLockState === "function"){
      var _als = window.applyLockState;
      window.applyLockState = function(){
        _als.apply(this, arguments);
        syncMemberPill();
      };
    }
  }catch(_){}
})();
</script>

</body>
</html>

